<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1e3c72">
    <meta name="description" content="Sistema de entrenamiento cognitivo Dual N-Back de grado cl√≠nico cient√≠fico. Mejora tu memoria de trabajo mediante entrenamiento adaptativo basado en investigaci√≥n neurocient√≠fica.">
    <meta name="keywords" content="dual n-back, memoria de trabajo, working memory, entrenamiento cognitivo, neuroplasticidad, TDAH, inteligencia fluida">
    <meta name="author" content="Dual N-Back Pro Research Team">
    <title>Dual N-Back Pro v3.0 ‚Ä¢ Entrenamiento Cognitivo Cient√≠fico</title>

    <!-- Chart.js para visualizaciones -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        :root {
            --primary-dark: #1e3c72;
            --primary-mid: #2a5298;
            --primary-light: #4a6fa5;
            --accent-cyan: #00d2ff;
            --accent-blue: #3a7bd5;
            --success: #4caf50;
            --warning: #ff9800;
            --error: #f44336;
            --glass-bg: rgba(255, 255, 255, 0.97);
            --shadow-strong: 0 20px 60px rgba(0, 0, 0, 0.3);
            --gold: #ffd700;
            --silver: #c0c0c0;
            --bronze: #cd7f32;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }

        html {
            height: 100%;
            height: -webkit-fill-available;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            background-attachment: fixed;
            height: 100vh;
            height: -webkit-fill-available;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #2c3e50;
            overflow: hidden;
            position: fixed;
            width: 100%;
            -webkit-font-smoothing: antialiased;
            transition: background 0.3s, color 0.3s;
        }

        /* Modo Oscuro */
        body.dark-mode {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #e0e0e0;
        }

        body.dark-mode .app-container {
            background: rgba(30, 30, 30, 0.95);
        }

        body.dark-mode .screen,
        body.dark-mode .card,
        body.dark-mode .academic-box {
            background: #2d2d2d !important;
            color: #e0e0e0 !important;
        }

        body.dark-mode .btn-secondary {
            background: #424242 !important;
            color: #fff !important;
        }

        body.dark-mode p,
        body.dark-mode li {
            color: #c5c5c5 !important;
        }

        .app-container {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 24px;
            box-shadow: var(--shadow-strong);
            width: 100%;
            max-width: 1100px;
            height: 100%;
            max-height: 95vh;
            max-height: -webkit-fill-available;
            padding: 1.5rem;
            position: relative;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .app-container::-webkit-scrollbar {
            width: 8px;
        }

        .app-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .app-container::-webkit-scrollbar-thumb {
            background: var(--accent-blue);
            border-radius: 10px;
        }

        .home-btn-fixed {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 55px;
            height: 55px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(0,0,0,0.35);
            z-index: 9999;
            border: 3px solid white;
            transition: transform 0.2s;
            touch-action: manipulation;
        }

        .home-btn-fixed:active {
            transform: scale(0.9);
        }

        /* Bot√≥n de modo oscuro */
        .dark-mode-toggle {
            position: fixed;
            top: 80px;
            right: 15px;
            width: 55px;
            height: 55px;
            background: linear-gradient(135deg, #424242, #616161);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(0,0,0,0.35);
            z-index: 9998;
            border: 3px solid white;
            transition: transform 0.2s, background 0.3s;
            touch-action: manipulation;
        }

        .dark-mode-toggle:active {
            transform: scale(0.9);
        }

        body.dark-mode .dark-mode-toggle {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
        }

        .screen {
            display: none;
            opacity: 0;
            animation: fadeIn 0.4s ease-in-out forwards;
            padding-bottom: 60px;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            color: var(--primary-dark);
            font-size: clamp(1.8rem, 5vw, 2.8rem);
            text-align: center;
            margin-bottom: 1rem;
            font-weight: 800;
        }

        body.dark-mode h1 {
            color: #90caf9;
        }

        h2 {
            color: var(--primary-mid);
            font-size: clamp(1.3rem, 4vw, 1.9rem);
            margin: 2.5rem 0 1.2rem;
            border-bottom: 3px solid #e8eaf6;
            padding-bottom: 0.6rem;
            font-weight: 700;
        }

        body.dark-mode h2 {
            color: #64b5f6;
            border-bottom-color: #424242;
        }

        h3 {
            color: var(--primary-light);
            font-size: clamp(1.1rem, 3vw, 1.4rem);
            margin: 1.8rem 0 0.9rem;
            font-weight: 600;
        }

        body.dark-mode h3 {
            color: #42a5f5;
        }

        h4 {
            color: var(--primary-mid);
            font-size: clamp(1rem, 2.5vw, 1.2rem);
            margin: 1.5rem 0 0.7rem;
            font-weight: 600;
        }

        p {
            margin-bottom: 1rem;
            line-height: 1.8;
            text-align: justify;
            font-size: clamp(0.9rem, 2.5vw, 1.05rem);
            color: #37474f;
        }

        ul, ol {
            margin-left: 1.8rem;
            margin-bottom: 1rem;
            line-height: 1.7;
        }

        li {
            margin-bottom: 0.6rem;
            font-size: clamp(0.9rem, 2.5vw, 1rem);
        }

        .btn {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 14px;
            font-weight: 700;
            font-size: clamp(0.95rem, 2.5vw, 1.1rem);
            cursor: pointer;
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(58, 123, 213, 0.35);
            width: 100%;
            margin: 8px 0;
            touch-action: manipulation;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #eceff1;
            color: #37474f;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef5350, #c62828);
        }

        .btn-success {
            background: linear-gradient(135deg, #66bb6a, #2e7d32);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffa726, #ef6c00);
        }

        .btn-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin: 2rem 0;
        }

        .main-action-btn {
            padding: 3rem 2rem;
            font-size: clamp(1.5rem, 4vw, 2rem);
            flex-direction: column;
            min-height: 200px;
            background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
            box-shadow: 0 8px 24px rgba(67, 160, 71, 0.4);
        }

        .main-action-btn .icon {
            font-size: clamp(3rem, 8vw, 4.5rem);
            margin-bottom: 0.5rem;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: clamp(10px, 2.5vw, 16px);
            max-width: 450px;
            margin: 0 auto 1.5rem;
            padding: clamp(12px, 3vw, 20px);
            background: #f5f7fa;
            border-radius: 20px;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.06);
        }

        body.dark-mode .grid-container {
            background: #1a1a1a;
        }

        .grid-cell {
            aspect-ratio: 1;
            background: white;
            border-radius: 14px;
            border: 3px solid transparent;
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            justify-content: center;
            align-items: center;
            color: transparent;
            font-size: 0;
            position: relative;
        }

        body.dark-mode .grid-cell {
            background: #2d2d2d;
        }

        .grid-cell::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 11px;
            opacity: 0;
            background: linear-gradient(135deg, #3f51b5, #5c6bc0);
            transition: opacity 0.2s;
        }

        .grid-cell.active::after {
            opacity: 1;
        }

        .grid-cell.active {
            transform: scale(0.92);
            box-shadow: 0 0 20px rgba(63, 81, 181, 0.6);
            border-color: var(--accent-cyan);
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.2rem;
            flex-wrap: wrap;
            gap: 0.8rem;
        }

        .level-badge {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-mid));
            color: white;
            padding: 8px 18px;
            border-radius: 20px;
            font-weight: 700;
            font-size: clamp(0.9rem, 2.5vw, 1.05rem);
            box-shadow: 0 3px 10px rgba(30, 60, 114, 0.3);
        }

        .mode-badge {
            background: var(--warning);
            color: white;
            padding: 6px 14px;
            border-radius: 15px;
            font-weight: 600;
            font-size: clamp(0.8rem, 2vw, 0.95rem);
        }

        .realtime-score {
            display: flex;
            justify-content: space-around;
            gap: 1rem;
            background: white;
            padding: 14px;
            border-radius: 14px;
            margin-bottom: 1.2rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            transition: opacity 0.3s, transform 0.3s;
        }

        body.dark-mode .realtime-score {
            background: #2d2d2d;
        }

        body.zen-mode .realtime-score {
            opacity: 0;
            transform: scale(0.9);
            pointer-events: none;
            height: 0;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        .score-item {
            text-align: center;
            flex: 1;
        }

        .score-value {
            font-size: clamp(1.8rem, 5vw, 2.4rem);
            font-weight: 800;
            margin-bottom: 0.4rem;
        }

        .score-value.hits {
            color: var(--success);
        }

        .score-value.errors {
            color: var(--error);
        }

        .score-label {
            font-size: clamp(0.75rem, 2vw, 0.9rem);
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .feedback-btn {
            min-height: 90px;
            font-size: clamp(1.1rem, 3vw, 1.4rem);
            flex-direction: column;
            gap: 6px;
        }

        .feedback-btn.matched {
            animation: feedback-pulse 0.3s ease;
        }

        body.zen-mode .feedback-btn.matched {
            animation: none;
        }

        @keyframes feedback-pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.08);
                background: linear-gradient(135deg, var(--success), #66bb6a);
                box-shadow: 0 0 25px rgba(76, 175, 80, 0.6);
            }
            100% {
                transform: scale(1);
            }
        }

        .academic-box {
            background: #f8f9fa;
            border-left: 4px solid var(--accent-blue);
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 12px 12px 0;
            font-size: clamp(0.88rem, 2.2vw, 1rem);
            line-height: 1.8;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .academic-box.adhd-highlight {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-left-color: #ff9800;
            border: 2px solid #ff9800;
            border-radius: 12px;
        }

        .academic-box.success-box {
            border-left-color: var(--success);
            background: #e8f5e9;
        }

        .academic-box.info-box {
            border-left-color: #2196f3;
            background: #e3f2fd;
        }

        .citation {
            font-size: clamp(0.75rem, 1.9vw, 0.88rem);
            color: #666;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #ddd;
            font-style: italic;
            line-height: 1.6;
        }

        .config-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 1.2rem;
            border-radius: 14px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        body.dark-mode .config-row {
            background: #2d2d2d;
        }

        .config-info {
            flex: 1;
        }

        .config-info strong {
            display: block;
            margin-bottom: 0.3rem;
            font-size: clamp(1rem, 2.5vw, 1.1rem);
            color: var(--primary-dark);
        }

        body.dark-mode .config-info strong {
            color: #90caf9;
        }

        .config-info small {
            color: #666;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
            line-height: 1.4;
        }

        body.dark-mode .config-info small {
            color: #aaa;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 54px;
            height: 30px;
            flex-shrink: 0;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input:checked + .slider {
            background-color: var(--success);
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }

        .level-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin: 2rem 0;
        }

        .level-btn {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: white;
            border: 3px solid #e0e0e0;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 700;
            font-size: clamp(1.2rem, 3vw, 1.5rem);
            color: var(--primary-dark);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        body.dark-mode .level-btn {
            background: #2d2d2d;
            color: #90caf9;
        }

        .level-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .level-btn.selected {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            color: white;
            border-color: var(--accent-cyan);
            box-shadow: 0 4px 16px rgba(58, 123, 213, 0.4);
        }

        .level-btn.locked {
            opacity: 0.3;
            cursor: not-allowed;
            pointer-events: none;
        }

        .level-btn small {
            font-size: 0.7rem;
            opacity: 0.8;
        }

        .device-selection {
            padding: 2rem 1rem;
            text-align: center;
        }

        .device-title {
            font-size: clamp(2.2rem, 6vw, 3.5rem);
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1.5rem;
            font-weight: 900;
        }

        .device-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            max-width: 700px;
            margin: 0 auto;
        }

        .device-card {
            background: white;
            padding: 2.5rem 2rem;
            border-radius: 20px;
            cursor: pointer;
            border: 4px solid transparent;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        body.dark-mode .device-card {
            background: #2d2d2d;
        }

        .device-card:active {
            transform: scale(0.98);
            border-color: var(--accent-blue);
        }

        .device-card-icon {
            font-size: clamp(4rem, 10vw, 5.5rem);
            margin-bottom: 1.2rem;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 1.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .stat-card {
            background: white;
            padding: 1.5rem 1rem;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            text-align: center;
        }

        body.dark-mode .stat-card {
            background: #2d2d2d;
        }

        .stat-value {
            font-size: clamp(2rem, 6vw, 2.8rem);
            font-weight: 800;
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
        }

        body.dark-mode .stat-value {
            color: #64b5f6;
        }

        .stat-label {
            font-size: clamp(0.75rem, 2vw, 0.9rem);
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        body.dark-mode table {
            background: #2d2d2d;
        }

        thead {
            background: #f5f7fa;
        }

        body.dark-mode thead {
            background: #1a1a1a;
        }

        th, td {
            padding: clamp(10px, 2.5vw, 14px);
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
        }

        body.dark-mode th,
        body.dark-mode td {
            border-bottom-color: #424242;
            color: #e0e0e0;
        }

        th {
            font-weight: 700;
            color: var(--primary-dark);
        }

        body.dark-mode th {
            color: #90caf9;
        }

        /* Notificaciones de logros */
        .achievement-notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            z-index: 10000;
            min-width: 280px;
            animation: slideInRight 0.5s ease-out;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        @media (max-width: 768px) {
            .app-container {
                padding: 1rem;
                border-radius: 16px;
            }

            .home-btn-fixed,
            .dark-mode-toggle {
                width: 50px;
                height: 50px;
                font-size: 1.4rem;
            }

            .menu-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .app-container {
                padding: 0.8rem;
                max-height: 100vh;
            }
        }
    </style>
</head>
<body>

    <!-- Bot√≥n Home Flotante -->
    <div class="home-btn-fixed" onclick="app.goHome()" title="Men√∫ Principal">üè†</div>

    <!-- Bot√≥n Modo Oscuro -->
    <div class="dark-mode-toggle" onclick="app.toggleDarkMode()" title="Alternar Modo Oscuro">üåì</div>

    <div class="app-container">

        <!-- PANTALLA: SELECCI√ìN DE DISPOSITIVO -->
        <div id="screen-device" class="screen active">
            <div class="device-selection">
                <h1 class="device-title">üß† Dual N-Back Pro v3.0</h1>
                <p style="text-align: center; color: #666; font-size: clamp(1rem, 2.5vw, 1.2rem); margin-bottom: 3rem;">
                    Sistema de Entrenamiento de Memoria de Trabajo Basado en Evidencia<br>
                    <small style="opacity: 0.8;">Selecciona tu dispositivo para optimizar controles y audio</small>
                </p>

                <div class="device-options">
                    <div class="device-card" onclick="app.selectDevice('desktop')">
                        <div class="device-card-icon">üíª</div>
                        <div style="font-size: clamp(1.3rem, 3.5vw, 1.7rem); font-weight: 700; margin-bottom: 0.5rem;">Computador</div>
                        <p style="text-align: center;">Control con teclado (Flechas ‚Üë‚Üì)</p>
                    </div>

                    <div class="device-card" onclick="app.selectDevice('mobile')">
                        <div class="device-card-icon">üì±</div>
                        <div style="font-size: clamp(1.3rem, 3.5vw, 1.7rem); font-weight: 700; margin-bottom: 0.5rem;">Smartphone</div>
                        <p style="text-align: center;">Botones t√°ctiles optimizados</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- PANTALLA: HOME/MEN√ö PRINCIPAL -->
        <div id="screen-home" class="screen">
            <div style="text-align: center; padding: 2rem 1rem;">
                <h1 style="font-size: clamp(2.5rem, 8vw, 4rem); margin-bottom: 0.5rem;">üß† Dual N-Back Pro</h1>
                <p style="font-style: italic; color: #546e7a; font-size: clamp(1rem, 2.5vw, 1.2rem); margin: 1.5rem 0; text-align: center;">
                    "El entrenamiento de la memoria de trabajo es a la mente lo que el ejercicio f√≠sico es al cuerpo"
                </p>

                <button class="main-action-btn" onclick="app.showLevelSelector()">
                    <div class="icon">üéØ</div>
                    <div>ENTRENAR</div>
                    <small style="opacity: 0.9; font-weight: 500;">Iniciar sesi√≥n de entrenamiento cognitivo</small>
                </button>
            </div>

            <div class="menu-grid">
                <button class="btn btn-secondary" onclick="app.showScreen('screen-instructions')">üìñ Instrucciones</button>
                <button class="btn btn-secondary" onclick="app.showScreen('screen-config')">‚öôÔ∏è Configuraci√≥n</button>
                <button class="btn btn-secondary" onclick="app.showScreen('screen-history')">üìä An√°lisis</button>
                <button class="btn btn-secondary" onclick="app.showScreen('screen-science')">üî¨ Base Cient√≠fica</button>
            </div>
        </div>
        <!-- PANTALLA: SELECTOR DE NIVEL -->
        <div id="screen-level-select" class="screen">
            <h1>üìä Selecci√≥n de Nivel</h1>

            <div class="academic-box info-box">
                <p><strong>Nivel M√°ximo Alcanzado:</strong> <span id="max-level-reached">1</span>-Back</p>
                <p style="margin-bottom: 0;"><small>Solo puedes entrenar en el nivel actual o niveles anteriores para consolidar el aprendizaje neurocognitivo.</small></p>
            </div>

            <div class="level-selector" id="level-selector"></div>

            <div class="btn-group">
                <button class="btn btn-success" onclick="app.startGameWithSelectedLevel()">‚úÖ Comenzar Entrenamiento</button>
                <button class="btn btn-secondary" onclick="app.goHome()">üè† Volver al Men√∫</button>
            </div>
        </div>

        <!-- PANTALLA: CONFIGURACI√ìN -->
        <div id="screen-config" class="screen">
            <h1>‚öôÔ∏è Configuraci√≥n Avanzada</h1>

            <h2>üéÆ Modos de Entrenamiento</h2>

            <div class="config-row">
                <div class="config-info">
                    <strong>üßò Modo Zen</strong>
                    <small>Oculta el score en tiempo real y feedback visual. Mayor validez ecol√≥gica para entrenamiento avanzado seg√∫n protocolos de Jaeggi et al. (2008).</small>
                </div>
                <label class="switch">
                    <input type="checkbox" id="toggle-zen" onchange="app.toggleZen()">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="config-row">
                <div class="config-info">
                    <strong>‚ö° Modo R√°pido</strong>
                    <small>Intervalo de 1500ms en lugar de 3000ms. Solo recomendado para usuarios experimentados (nivel ‚â•4). Aumenta demanda atencional y carga ejecutiva.</small>
                </div>
                <label class="switch">
                    <input type="checkbox" id="toggle-fast" onchange="app.toggleFast()">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="config-row">
                <div class="config-info">
                    <strong>üèÜ Sistema de Logros</strong>
                    <small>Activa notificaciones de logros y hitos de progreso. Mejora adherencia mediante refuerzo positivo (gamificaci√≥n basada en principios de aprendizaje).</small>
                </div>
                <label class="switch">
                    <input type="checkbox" id="toggle-achievements" onchange="app.toggleAchievements()" checked>
                    <span class="slider"></span>
                </label>
            </div>

            <h2>üíæ Gesti√≥n de Datos</h2>

            <div class="btn-group">
                <button class="btn btn-warning" onclick="app.exportData()">üíæ Exportar Datos (JSON)</button>
                <button class="btn" onclick="document.getElementById('import-file').click()">üìÇ Importar Datos</button>
                <input type="file" id="import-file" accept=".json" style="display:none" onchange="app.importData(event)">
            </div>

            <h2>üîä Sistema de Audio</h2>

            <div class="academic-box info-box">
                <p><strong>Importante para iOS/Safari:</strong> Los navegadores Apple requieren interacci√≥n del usuario antes de reproducir audio. Usa el bot√≥n de prueba abajo para activar el sistema de s√≠ntesis de voz.</p>
            </div>

            <button class="btn btn-secondary" onclick="app.testAudio()">üîä Probar Audio (Obligatorio iOS/Safari)</button>

            <h2>üé® Personalizaci√≥n</h2>

            <div class="config-row">
                <div class="config-info">
                    <strong>üåì Modo Oscuro</strong>
                    <small>Reduce fatiga visual en ambientes con poca luz. Alterna entre tema claro y oscuro.</small>
                </div>
                <label class="switch">
                    <input type="checkbox" id="toggle-darkmode-config" onchange="app.toggleDarkMode()">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="btn-group" style="margin-top: 3rem;">
                <button class="btn btn-secondary" onclick="app.goHome()">üè† Volver al Men√∫</button>
            </div>
        </div>

        <!-- PANTALLA: INSTRUCCIONES -->
        <div id="screen-instructions" class="screen">
            <h1>üìñ Protocolo de Entrenamiento Cient√≠fico</h1>

            <h2>üéØ Fundamentos del Dual N-Back</h2>

            <div class="academic-box success-box">
                <h3>Objetivo del Paradigma</h3>
                <p>El dual n-back es una tarea cognitiva que requiere el monitoreo simult√°neo de dos flujos de informaci√≥n (posici√≥n visual y letra auditiva) y la detecci√≥n de coincidencias con est√≠mulos presentados <strong>N posiciones atr√°s</strong> en la secuencia.</p>
                
                <p><strong>Est√≠mulos Duales:</strong></p>
                <ul>
                    <li><strong>Modalidad Visual:</strong> Un cuadrado azul se ilumina en una de las 9 posiciones de la cuadr√≠cula 3√ó3</li>
                    <li><strong>Modalidad Auditiva:</strong> Escuchar√°s una letra consonante (C, H, K, L, Q, R, S, T) pronunciada claramente</li>
                </ul>

                <p><strong>Tu tarea operacional:</strong> Presionar el bot√≥n correspondiente cuando:</p>
                <ul>
                    <li>La <strong>posici√≥n</strong> actual coincide con la posici√≥n N-turnos atr√°s ‚Üí Presionar "Posici√≥n"</li>
                    <li>La <strong>letra</strong> actual coincide con la letra N-turnos atr√°s ‚Üí Presionar "Sonido"</li>
                    <li><strong>Ambas</strong> coinciden simult√°neamente ‚Üí Presionar ambos botones</li>
                </ul>
            </div>

            <h3>üéÆ Controles del Sistema</h3>

            <div class="academic-box info-box">
                <p><strong id="controls-type">Computador (Teclado)</strong></p>
                <ul id="controls-list">
                    <li><strong>‚ñ≤ Flecha Arriba (‚Üë):</strong> Marcar coincidencia de POSICI√ìN visual</li>
                    <li><strong>‚ñº Flecha Abajo (‚Üì):</strong> Marcar coincidencia de SONIDO auditivo</li>
                    <li><strong>‚ñ≤ + ‚ñº Simult√°neas:</strong> Puedes presionar ambas teclas a la vez si ambas modalidades coinciden</li>
                </ul>
            </div>

            <h3>üìà Progresi√≥n de Niveles</h3>

            <div class="academic-box">
                <h4>üü¢ Nivel 1 (1-Back) - Iniciaci√≥n</h4>
                <p>Comparas con el est√≠mulo <strong>inmediatamente anterior</strong>. Si la posici√≥n del turno actual es igual a la del turno anterior, presiona "Posici√≥n". Si la letra actual es igual a la letra anterior, presiona "Sonido".</p>
                <p><em>Demanda cognitiva:</em> Baja. Requiere mantener 1 √≠tem dual en memoria de trabajo (WM capacity ‚âà 2 chunks).</p>

                <h4>üü° Nivel 2 (2-Back) - Intermedio</h4>
                <p>Comparas con el est√≠mulo de hace <strong>dos turnos</strong>. Debes mantener DOS elementos duales simult√°neamente en tu buffer de memoria de trabajo.</p>
                <p><em>Demanda cognitiva:</em> Media. WM capacity ‚âà 4 chunks. Requiere actualizaci√≥n continua (updating) del contenido de WM.</p>

                <h4>üü† Nivel 3 (3-Back) - Avanzado</h4>
                <p>Comparas con el est√≠mulo de hace <strong>tres turnos</strong>. La carga comienza a aproximarse al l√≠mite de capacidad de WM seg√∫n Cowan (2001): 4¬±1 chunks.</p>
                <p><em>Demanda cognitiva:</em> Alta. Requiere coordinaci√≥n ejecutiva sofisticada y resistencia a la interferencia proactiva.</p>

                <h4>üî¥ Nivel 4+ (4-Back y superiores) - Experto</h4>
                <p>A partir del nivel 4, la tarea excede la capacidad de WM de la mayor√≠a de individuos no entrenados. Requiere estrategias avanzadas de chunking y ensayo subvocal activo.</p>
                <p><em>Demanda cognitiva:</em> Muy alta. Solo alcanzable tras entrenamiento sostenido (8+ semanas). Nivel 7-Back representa rendimiento de percentil 99.</p>
            </div>

            <h2>‚úÖ Criterio Cient√≠fico de Avance (Protocolo de Jaeggi)</h2>

            <div class="academic-box info-box">
                <p>Este sistema implementa el criterio adaptativo basado en investigaci√≥n emp√≠rica:</p>
                <ul>
                    <li><strong>Avanzar al siguiente nivel:</strong> Precisi√≥n ‚â•85% (basado en Jaeggi et al., 2010)</li>
                    <li><strong>Mantener nivel actual:</strong> Precisi√≥n 70-84% (consolidaci√≥n necesaria)</li>
                    <li><strong>Considerar nivel inferior:</strong> Precisi√≥n <70% (sobrecarga cognitiva)</li>
                </ul>
                <p style="margin-bottom: 0;"><em>Fundamento:</em> El umbral del 85% asegura que el nivel est√° consolidado antes de aumentar la carga ejecutiva, maximizando la neuroplasticidad adaptativa (Buschkuehl et al., 2012).</p>
            </div>

            <h2>üóìÔ∏è Protocolo √ìptimo de Entrenamiento</h2>

            <div class="academic-box success-box">
                <h4>üìã Plan Basado en Evidencia</h4>
                <ul>
                    <li><strong>Frecuencia:</strong> 20-25 minutos diarios, 5 d√≠as por semana (protocolo est√°ndar)</li>
                    <li><strong>Duraci√≥n del programa:</strong> M√≠nimo 8 semanas, √≥ptimo 12-19 semanas para efectos robustos en Gf</li>
                    <li><strong>Ambiente:</strong> Silencioso, sin distracciones auditivas/visuales. Usa auriculares para discriminaci√≥n auditiva √≥ptima</li>
                    <li><strong>Horario:</strong> Preferiblemente en momentos de alta alerta (ma√±ana/tarde temprana). Evitar fatiga extrema</li>
                    <li><strong>Adherencia:</strong> La consistencia es cr√≠tica. Interrupciones >3 d√≠as comprometen efectos acumulativos</li>
                </ul>

                <h4>üìä Expectativas de Progreso Realistas</h4>
                <ul>
                    <li><strong>Semanas 1-2:</strong> Familiarizaci√≥n con la tarea. Mejoras r√°pidas en nivel n alcanzado (curva de aprendizaje procedural)</li>
                    <li><strong>Semanas 3-4:</strong> Meseta temporal (plateau) es NORMAL. Continuar es crucial. Fase de consolidaci√≥n</li>
                    <li><strong>Semanas 5-8:</strong> Mejoras sostenidas en capacidad de WM. Transferencia cercana (near transfer) a otras tareas WM se hace evidente</li>
                    <li><strong>Semanas 8-12:</strong> Posible emergencia de transferencia lejana (far transfer) a inteligencia fluida (Gf). Efectos individualizados</li>
                    <li><strong>Mantenimiento:</strong> Despu√©s de 12 semanas, reducir frecuencia a 2-3 d√≠as/semana para mantener ganancias</li>
                </ul>
            </div>

            <h2>üß™ Variables Moduladoras del Efecto</h2>

            <div class="academic-box">
                <p><strong>Factores que predicen mayor beneficio:</strong></p>
                <ul>
                    <li><strong>Capacidad basal baja-media:</strong> Individuos con WM baseline baja muestran mayores ganancias (Jaeggi et al., 2011)</li>
                    <li><strong>Motivaci√≥n intr√≠nseca:</strong> Engagement y persistencia correlacionan fuertemente con efectos (r = 0.45-0.60)</li>
                    <li><strong>Polimorfismo COMT:</strong> Variante Met/Met asociada a mayor plasticidad dopamin√©rgica en DLPFC (Brehmer et al., 2009)</li>
                    <li><strong>Conectividad funcional basal:</strong> Mayor FC fronto-parietal predice mejor respuesta (Jost et al., 2021)</li>
                </ul>
            </div>

            <div class="btn-group">
                <button class="btn btn-success" onclick="app.showLevelSelector()">üöÄ Comenzar Entrenamiento</button>
                <button class="btn btn-secondary" onclick="app.goHome()">üè† Volver al Men√∫</button>
            </div>
        </div>

        <!-- PANTALLA: JUEGO -->
        <div id="screen-game" class="screen">
            <div class="game-header">
                <div>
                    <span class="level-badge" id="game-level-badge">Nivel 1-Back</span>
                    <span class="mode-badge" id="game-mode-badge" style="display:none;">‚ö° R√°pido</span>
                </div>
                <div style="font-size: clamp(0.85rem, 2vw, 0.95rem); color: #666;">
                    <span>Ronda <strong id="game-round">0</strong>/<strong id="game-max-rounds">20</strong></span>
                </div>
            </div>

            <div class="realtime-score" id="realtime-score">
                <div class="score-item">
                    <div class="score-value hits" id="score-hits">0</div>
                    <div class="score-label">Aciertos</div>
                </div>
                <div class="score-item">
                    <div class="score-value errors" id="score-errors">0</div>
                    <div class="score-label">Errores</div>
                </div>
            </div>

            <div class="grid-container" id="game-grid"></div>

            <div style="text-align: center; height: 25px; margin-bottom: 15px; color: #999; font-size: clamp(0.75rem, 2vw, 0.85rem);">
                <span id="audio-indicator">üéß Escucha atentamente...</span>
            </div>

            <!-- Controles Desktop -->
            <div id="desktop-controls" style="display: none; justify-content: center; gap: 15px; margin-bottom: 1rem;">
                <button class="btn feedback-btn" id="btn-pos-desk" onclick="game.handleInput('pos')">
                    üìç Posici√≥n<br><small>‚ñ≤ Flecha ‚Üë</small>
                </button>
                <button class="btn feedback-btn" id="btn-audio-desk" onclick="game.handleInput('audio')">
                    üîä Sonido<br><small>‚ñº Flecha ‚Üì</small>
                </button>
            </div>

            <!-- Controles Mobile -->
            <div id="mobile-controls" style="display: none; gap: 15px; margin-bottom: 1rem;">
                <button class="btn feedback-btn" id="btn-pos-mobile" ontouchstart="game.handleInput('pos')" onclick="game.handleInput('pos')">
                    üìç Posici√≥n
                </button>
                <button class="btn feedback-btn" id="btn-audio-mobile" ontouchstart="game.handleInput('audio')" onclick="game.handleInput('audio')">
                    üîä Sonido
                </button>
            </div>

            <button class="btn btn-danger" style="margin-top: 2rem; max-width: 250px; margin-left: auto; margin-right: auto;" onclick="app.quitGame()">
                ‚ùå Salir de la Sesi√≥n
            </button>
        </div>

        <!-- PANTALLA: RESULTADOS -->
        <div id="screen-results" class="screen">
            <h1>üéØ Resultados de la Sesi√≥n</h1>

            <div id="result-verdict" class="academic-box" style="text-align: center; font-size: clamp(1.1rem, 3vw, 1.3rem); font-weight: 700; margin-bottom: 2rem;"></div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="result-accuracy">0%</div>
                    <div class="stat-label">Precisi√≥n</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="result-level">1</div>
                    <div class="stat-label">Nivel</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="result-hits">0</div>
                    <div class="stat-label">Aciertos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="result-errors">0</div>
                    <div class="stat-label">Errores</div>
                </div>
            </div>

            <div style="height: 300px; background: white; padding: 15px; border-radius: 16px; margin: 2rem 0; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                <canvas id="result-chart"></canvas>
            </div>

            <div class="btn-group" id="result-buttons"></div>
        </div>

        <!-- PANTALLA: HISTORIAL/AN√ÅLISIS -->
        <div id="screen-history" class="screen">
            <h1>üìä An√°lisis de Rendimiento Longitudinal</h1>

            <div id="history-summary" class="stats-grid"></div>

            <h2>üìà Historial por Nivel N-Back</h2>

            <div class="academic-box info-box">
                <p style="margin-bottom: 0;"><small>Cada nivel tiene sus propias estad√≠sticas y curvas de aprendizaje. Selecciona un nivel para visualizar m√©tricas espec√≠ficas de desempe√±o:</small></p>
            </div>

            <div style="display: flex; gap: 8px; flex-wrap: wrap; margin: 1rem 0;">
                <button class="btn btn-secondary" style="flex: 1; min-width: 80px;" onclick="app.showHistoryForLevel('all')">Todos</button>
                <button class="btn btn-secondary" style="flex: 1; min-width: 80px;" onclick="app.showHistoryForLevel(1)">Nivel 1</button>
                <button class="btn btn-secondary" style="flex: 1; min-width: 80px;" onclick="app.showHistoryForLevel(2)">Nivel 2</button>
                <button class="btn btn-secondary" style="flex: 1; min-width: 80px;" onclick="app.showHistoryForLevel(3)">Nivel 3</button>
                <button class="btn btn-secondary" style="flex: 1; min-width: 80px;" onclick="app.showHistoryForLevel(4)">Nivel 4</button>
                <button class="btn btn-secondary" style="flex: 1; min-width: 80px;" onclick="app.showHistoryForLevel(5)">Nivel 5</button>
                <button class="btn btn-secondary" style="flex: 1; min-width: 80px;" onclick="app.showHistoryForLevel(6)">Nivel 6</button>
                <button class="btn btn-secondary" style="flex: 1; min-width: 80px;" onclick="app.showHistoryForLevel(7)">Nivel 7</button>
                <button class="btn btn-secondary" style="flex: 1; min-width: 80px;" onclick="app.showHistoryForLevel(8)">Nivel 8</button>
                <button class="btn btn-secondary" style="flex: 1; min-width: 80px;" onclick="app.showHistoryForLevel(9)">Nivel 9</button>
                <button class="btn btn-secondary" style="flex: 1; min-width: 80px;" onclick="app.showHistoryForLevel(10)">Nivel 10</button>
            </div>

            <div style="height: 350px; background: white; padding: 15px; border-radius: 16px; margin: 2rem 0; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                <canvas id="history-chart"></canvas>
            </div>

            <div id="history-table-container"></div>

            <h2>üèÜ Logros Desbloqueados</h2>
            <div id="achievements-display" style="margin: 2rem 0;"></div>

            <div class="btn-group">
                <button class="btn btn-warning" onclick="app.shareResults()">üì§ Compartir Progreso</button>
                <button class="btn btn-danger" onclick="app.clearHistory()">üóëÔ∏è Borrar Historial Completo</button>
                <button class="btn btn-secondary" onclick="app.goHome()">üè† Volver al Men√∫</button>
            </div>
        </div>

        <!-- PANTALLA: BASE CIENT√çFICA (EXPANDIDA) -->
        <div id="screen-science" class="screen">
            <h1>üî¨ Fundamentaci√≥n Neurocient√≠fica Completa</h1>

            <div style="font-family: Georgia, 'Times New Roman', serif; font-style: italic; font-size: clamp(0.95rem, 2.3vw, 1.05rem); text-align: justify; color: #263238; padding: 2rem clamp(1rem, 3vw, 2rem); background: linear-gradient(135deg, rgba(58,123,213,0.08) 0%, rgba(0,210,255,0.08) 100%); border-radius: 16px; margin: 2rem 0; line-height: 1.95; box-shadow: 0 4px 16px rgba(0,0,0,0.08);">
                La memoria de trabajo constituye el escenario temporal donde la consciencia orquesta la danza de la cognici√≥n activa, funcionando como el procesador de informaci√≥n en tiempo real del sistema nervioso humano. Este sistema ejecutivo, lejos de ser un almac√©n pasivo, representa el n√∫cleo din√°mico de nuestras capacidades cognitivas superiores, mediando desde la comprensi√≥n del lenguaje hasta el razonamiento abstracto y la planificaci√≥n conductual compleja. El entrenamiento sistem√°tico de este componente cr√≠tico de la arquitectura cognitiva humana promete no solo mejoras en tareas espec√≠ficas, sino potencial transferencia a dominios cognitivos generales, incluyendo la esquiva y tradicionalmente considerada inmutable inteligencia fluida.
            </div>

            <h2>I. Arquitectura Cognitiva: Modelo Multicomponente de Baddeley</h2>

            <div class="academic-box">
                <h3>1.1 Marco Conceptual Fundacional</h3>
                <p>El paradigma dual n-back se fundamenta en el modelo multicomponente de memoria de trabajo propuesto por Baddeley y Hitch (1974) y refinado extensivamente durante cinco d√©cadas de investigaci√≥n emp√≠rica acumulativa. Este modelo postula que la <strong>memoria de trabajo (WM)</strong> no constituye una entidad unitaria monol√≠tica, sino un sistema ejecutivo fraccionado en subsistemas especializados que operan de manera coordinada pero semi-independiente, permitiendo el procesamiento paralelo de informaci√≥n multimodal.</p>

                <p><strong>La arquitectura tripartita cl√°sica comprende:</strong></p>

                <ul>
                    <li><strong>Ejecutivo Central (Central Executive):</strong> Sistema atencional de capacidad limitada que funciona como controlador supervisor responsable de la coordinaci√≥n, supervisi√≥n y control de los subsistemas esclavos. Ejecuta funciones metacognitivas cr√≠ticas incluyendo: (a) <em>updating</em> o actualizaci√≥n continua de representaciones mentales activas, (b) <em>shifting</em> o cambio flexible entre tareas o conjuntos mentales (task-switching), (c) <em>inhibition</em> o inhibici√≥n de respuestas prepotentes e informaci√≥n irrelevante, y (d) distribuci√≥n estrat√©gica de recursos atencionales limitados seg√∫n demandas de tarea.</li>

                    <li><strong>Bucle Fonol√≥gico (Phonological Loop):</strong> Subsistema especializado en el procesamiento y mantenimiento temporal de informaci√≥n auditivo-verbal. Opera mediante dos componentes funcionalmente disociables: el <em>almac√©n fonol√≥gico pasivo</em> (que retiene trazas ac√∫sticas durante aproximadamente 2 segundos antes de su desvanecimiento por decaimiento temporal) y el <em>proceso de ensayo articulatorio subvocal</em> (que refresca activamente dichas trazas mediante repetici√≥n encubierta, an√°logo a un "loop" de ensayo interno).</li>

                    <li><strong>Agenda Visuoespacial (Visuospatial Sketchpad):</strong> Sistema an√°logo dedicado al procesamiento de informaci√≥n visual (identidad de objetos - "qu√©") y espacial (localizaci√≥n y relaciones espaciales - "d√≥nde"). Estudios de neuroimagen funcional (fMRI) sugieren disociaciones anat√≥micas entre componentes visuales (corteza temporal inferior) y espaciales (corteza parietal posterior), reflejando la divisi√≥n dorsal-ventral del procesamiento visual cortical.</li>

                    <li><strong>Buffer Epis√≥dico (Episodic Buffer):</strong> A√±adido posteriormente al modelo original (Baddeley, 2000), funciona como interfaz integradora multidimensional que vincula informaci√≥n proveniente de los subsistemas esclavos con representaciones almacenadas en la memoria a largo plazo (LTM), creando representaciones multimodales coherentes, conscientes y temporalmente extendidas que forman la base de la experiencia epis√≥dica consciente.</li>
                </ul>

                <p><strong>Implementaci√≥n en Dual N-Back:</strong> El entrenamiento dual n-back sobrecarga simult√°neamente el bucle fonol√≥gico (mediante presentaci√≥n secuencial de letras auditivas) y la agenda visuoespacial (posiciones en cuadr√≠cula 3√ó3), forzando al ejecutivo central a coordinar, actualizar y mantener ambos flujos de informaci√≥n bajo severas restricciones temporales, maximizando as√≠ la demanda sobre el sistema de control ejecutivo.</p>

                <div class="citation">
                    Baddeley, A. D., & Hitch, G. (1974). Working memory. En G. H. Bower (Ed.), <em>The psychology of learning and motivation: Advances in research and theory</em> (Vol. 8, pp. 47-89). Academic Press.
                    <br><br>
                    Baddeley, A. (2000). The episodic buffer: A new component of working memory? <em>Trends in Cognitive Sciences, 4</em>(11), 417-423. https://doi.org/10.1016/S1364-6613(00)01538-2
                    <br><br>
                    Baddeley, A. (2012). Working memory: Theories, models, and controversies. <em>Annual Review of Psychology, 63</em>, 1-29. https://doi.org/10.1146/annurev-psych-120710-100422
                </div>
            </div>

            <div class="academic-box info-box">
                <h3>1.2 Capacidad Limitada: El N√∫mero M√°gico y sus Revisiones</h3>
                <p>La capacidad de memoria de trabajo muestra restricciones severas y cuantificables que constituyen un cuello de botella fundamental en el procesamiento cognitivo humano. Miller (1956) propuso el c√©lebre "n√∫mero m√°gico" <strong>7¬±2</strong> como l√≠mite general de capacidad basado en estudios de span de memoria inmediata (d√≠gitos, palabras, tonos).</p>

                <p>Sin embargo, investigaci√≥n contempor√°nea utilizando paradigmas m√°s controlados y metodolog√≠a anal√≠tica sofisticada (Cowan, 2001; Cowan, 2010) sugiere l√≠mites m√°s conservadores y realistas: aproximadamente <strong>4¬±1 chunks</strong> de informaci√≥n para representaciones multimodales complejas, con variabilidad inter-individual sustancial (rango emp√≠rico: 2-6 √≠tems en poblaci√≥n general adulta).</p>

                <p><strong>Factores que modulan la capacidad efectiva:</strong></p>
                <ul>
                    <li><strong>Chunking:</strong> Agrupaci√≥n de elementos discretos en unidades significativas de orden superior mediante vinculaci√≥n con conocimiento pre-existente en LTM (Chase & Simon, 1973 - estudios cl√°sicos en ajedrecistas expertos)</li>
                    <li><strong>Ensayo elaborativo:</strong> Procesamiento profundo que vincula activamente material nuevo con estructuras sem√°nticas pre-existentes, incrementando durabilidad y accesibilidad de trazas</li>
                    <li><strong>Supresi√≥n articulatoria:</strong> La prevenci√≥n del ensayo subvocal mediante tareas articulatorias concurrentes (e.g., repetir "la-la-la") reduce dram√°ticamente el span verbal, evidenciando rol cr√≠tico del bucle fonol√≥gico</li>
                    <li><strong>Entrenamiento sistem√°tico:</strong> Expansi√≥n adaptativa de capacidad mediante neuroplasticidad estructural y funcional (tema central del presente programa)</li>
                </ul>

                <div class="citation">
                    Miller, G. A. (1956). The magical number seven, plus or minus two: Some limits on our capacity for processing information. <em>Psychological Review, 63</em>(2), 81-97.
                    <br><br>
                    Cowan, N. (2001). The magical number 4 in short-term memory: A reconsideration of mental storage capacity. <em>Behavioral and Brain Sciences, 24</em>(1), 87-114. https://doi.org/10.1017/S0140525X01003922
                    <br><br>
                    Chase, W. G., & Simon, H. A. (1973). Perception in chess. <em>Cognitive Psychology, 4</em>(1), 55-81.
                </div>
            </div>

            <h2>II. Sustratos Neurales: Redes Fronto-Parietales</h2>

            <div class="academic-box">
                <h3>2.1 Corteza Prefrontal Dorsolateral (DLPFC) - Hub Ejecutivo</h3>
                <p>La evidencia convergente de neuroimagen funcional (fMRI, PET), estimulaci√≥n magn√©tica transcraneal (TMS), estimulaci√≥n transcraneal de corriente directa (tDCS) y estudios lesionales establece inequ√≠vocamente que la <strong>corteza prefrontal dorsolateral (DLPFC, √°reas de Brodmann 9 y 46)</strong> constituye el sustrato neural cr√≠tico de la memoria de trabajo ejecutiva y el control cognitivo de orden superior.</p>

                <p>El meta-an√°lisis comprehensivo de Owen et al. (2005) integr√≥ 60+ estudios de neuroimagen funcional (>1,200 participantes) identificando activaci√≥n consistente y robusta de DLPFC bilateral durante tareas n-back, con lateralizaci√≥n hemisf√©rica parcial dependiente de modalidad estimular:</p>

                <ul>
                    <li><strong>DLPFC izquierda (√°rea 9/46 izquierda):</strong> Predominantemente reclutada durante procesamiento de informaci√≥n verbal-simb√≥lica. Activaci√≥n correlaciona positivamente con carga de WM (incrementos lineales desde 1-back hasta 3-back)</li>
                    <li><strong>DLPFC derecha (√°rea 9/46 derecha):</strong> Mayor involucraci√≥n en procesamiento espacial y monitoreo de informaci√≥n visuoespacial. Rol destacado en memoria espacial de objetos y navegaci√≥n mental</li>
                </ul>

                <p><strong>Caracter√≠sticas funcionales distintivas de DLPFC durante tareas WM:</strong></p>
                <ul>
                    <li><strong>Modulaci√≥n por carga:</strong> Activaci√≥n incrementa monot√≥nicamente con nivel n (1-back < 2-back < 3-back), reflejando demandas incrementales de control ejecutivo (Braver et al., 1997; Cohen et al., 1997)</li>
                    <li><strong>Activaci√≥n sostenida:</strong> DLPFC muestra actividad t√≥nica durante per√≠odos de mantenimiento activo, no solo durante codificaci√≥n o recuperaci√≥n, consistente con rol en mantenimiento online de representaciones</li>
                    <li><strong>Eficiencia neural post-entrenamiento:</strong> Tras entrenamiento cognitivo, DLPFC muestra <em>reducci√≥n</em> de activaci√≥n para mismo nivel de dificultad (Hempel et al., 2004), indicando procesamiento m√°s eficiente que requiere menor reclutamiento neural - an√°logo a automatizaci√≥n</li>
                </ul>

                <div class="citation">
                    Owen, A. M., McMillan, K. M., Laird, A. R., & Bullmore, E. (2005). N-back working memory paradigm: A meta-analysis of normative functional neuroimaging studies. <em>Human Brain Mapping, 25</em>(1), 46-59. https://doi.org/10.1002/hbm.20131
                    <br><br>
                    Braver, T. S., Cohen, J. D., Nystrom, L. E., Jonides, J., Smith, E. E., & Noll, D. C. (1997). A parametric study of prefrontal cortex involvement in human working memory. <em>NeuroImage, 5</em>(1), 49-62.
                    <br><br>
                    Hempel, A., Giesel, F. L., Garcia Caraballo, N. M., Amann, M., Meyer, H., W√ºstenberg, T., ... & Schr√∂der, J. (2004). Plasticity of cortical activation related to working memory during training. <em>American Journal of Psychiatry, 161</em>(4), 745-747.
                </div>
            </div>

            <div class="academic-box info-box">
                <h3>2.2 Redes de Conectividad Funcional</h3>
                <p>La memoria de trabajo no reside exclusivamente en DLPFC como m√≥dulo aislado, sino que emerge de la interacci√≥n din√°mica y sincronizada de redes distribuidas a gran escala. El an√°lisis de conectividad funcional mediante correlaciones temporales en se√±ales BOLD revela dos redes cr√≠ticas:</p>

                <h4>üî∑ Red Fronto-Parietal (FPN - Frontoparietal Network)</h4>
                <p>Sistema de control ejecutivo flexible que comprende DLPFC, corteza parietal posterior (√°reas intraparietales IPS - intraparietal sulcus), y uni√≥n temporo-parietal (TPJ). Implementa procesos de control top-down: selecci√≥n de informaci√≥n relevante orientada a metas, supresi√≥n activa de distractores e informaci√≥n irrelevante, actualizaci√≥n din√°mica de representaciones mentales, y coordinaci√≥n de operaciones ejecutivas complejas.</p>

                <h4>üî∂ Red de Saliencia/Control Cognitivo (Salience Network)</h4>
                <p>Sistema de detecci√≥n de eventos relevantes que incluye corteza cingulada anterior dorsal (dACC - dorsal anterior cingulate cortex) e √≠nsula anterior bilateral. Funciones principales: monitoreo continuo de demandas de tarea y detecci√≥n de conflictos, detecci√≥n de errores y violaciones de expectativas (error monitoring), regulaci√≥n de arousal y alerta t√≥nica para mantener estados de configuraci√≥n de tarea (task-set maintenance), y modulaci√≥n de la interfaz entre procesamiento interno (default mode) y orientado externamente (executive control).</p>

                <p><strong>Evidencia emp√≠rica clave:</strong> Estudios de conectividad funcional en reposo (resting-state fMRI) demuestran que la fuerza de conectividad intr√≠nseca entre nodos de estas redes predice diferencias individuales en capacidad de memoria de trabajo (r = 0.35-0.55) incluso en ausencia de tarea expl√≠cita (Sala-Llonch et al., 2012; Hampson et al., 2006). Esto sugiere que las redes WM poseen organizaci√≥n intr√≠nseca que precede y constra√±e el desempe√±o cognitivo.</p>

                <div class="citation">
                    Sala-Llonch, R., Pe√±a-G√≥mez, C., Arenaza-Urquijo, E. M., Vidal-Pi√±eiro, D., Bargall√≥, N., Junqu√©, C., & Bartr√©s-Faz, D. (2012). Brain connectivity during resting state and subsequent working memory task predicts behavioural performance. <em>Cortex, 48</em>(9), 1187-1196.
                    <br><br>
                    Hampson, M., Driesen, N. R., Skudlarski, P., Gore, J. C., & Constable, R. T. (2006). Brain connectivity related to working memory performance. <em>Journal of Neuroscience, 26</em>(51), 13338-13343.
                </div>
            </div>

            <h2>III. Neuroplasticidad y Efectos del Entrenamiento</h2>

            <div class="academic-box success-box">
                <h3>3.1 Hallazgo Revolucionario: Jaeggi et al. (2008)</h3>
                <p>El trabajo seminal y paradigm√°ticamente disruptivo de Jaeggi, Buschkuehl, Jonides y Perrig (2008) publicado en <em>Proceedings of the National Academy of Sciences (PNAS)</em> demostr√≥ por primera vez en la historia de la psicolog√≠a cognitiva que el entrenamiento adaptativo en dual n-back produc√≠a mejoras significativas en <strong>inteligencia fluida (Gf)</strong>, la capacidad de razonar y resolver problemas novedosos independientemente de conocimiento previo, medida mediante Test de Matrices Progresivas de Raven (Advanced Progressive Matrices - APM) y Test de Analog√≠as Verbales (BOMAT - Bochumer Matrizentest).</p>

                <p><strong>Dise√±o experimental del estudio pionero:</strong></p>
                <ul>
                    <li><strong>N = 70 participantes</strong> adultos j√≥venes sin patolog√≠a neuropsiqui√°trica</li>
                    <li><strong>Grupos experimentales:</strong> Entrenamiento durante 8, 12, 17 o 19 d√≠as (manipulaci√≥n de dosis)</li>
                    <li><strong>Tarea de entrenamiento:</strong> Dual n-back adaptativo (nivel ajustado continuamente seg√∫n desempe√±o individual)</li>
                    <li><strong>Medidas de resultado:</strong> Tests de inteligencia fluida (APM, BOMAT) administrados pre y post-entrenamiento</li>
                    <li><strong>Grupo control:</strong> Sin entrenamiento (dise√±o between-subjects)</li>
                </ul>

                <p><strong>Resultados revolucionarios:</strong></p>
                <ul>
                    <li>Mejoras significativas en Gf post-entrenamiento vs. control (tama√±o del efecto d = 0.4-0.65 dependiendo de test)</li>
                    <li><strong>Efecto dependiente de dosis:</strong> Correlaci√≥n positiva entre d√≠as de entrenamiento y magnitud de mejora en Gf (r = 0.46, p < 0.01) - m√°s entrenamiento produce mayor transferencia</li>
                    <li>Efectos observados tanto en medidas verbales como no-verbales de Gf, sugiriendo transferencia a procesos cognitivos generales</li>
                    <li><strong>Implicaci√≥n te√≥rica:</strong> Por primera vez se demostraba que un rasgo tradicionalmente considerado est√°tico y determinado gen√©ticamente (inteligencia fluida, heredabilidad h¬≤ ‚âà 0.5-0.7) pod√≠a ser modificado mediante intervenci√≥n conductual</li>
                </ul>

                <p>Este hallazgo inaugur√≥ la era moderna del "entrenamiento cognitivo" (cognitive training) y gener√≥ controversia cient√≠fica sustancial, estimulando d√©cadas de investigaci√≥n subsecuente.</p>

                <div class="citation">
                    Jaeggi, S. M., Buschkuehl, M., Jonides, J., & Perrig, W. J. (2008). Improving fluid intelligence with training on working memory. <em>Proceedings of the National Academy of Sciences, 105</em>(19), 6829-6833. https://doi.org/10.1073/pnas.0801268105
                </div>
            </div>

            <div class="academic-box">
                <h3>3.2 Debate Cient√≠fico y Meta-An√°lisis: Magnitud de Efectos</h3>
                <p>El entusiasmo inicial generado por Jaeggi et al. (2008) precipit√≥ una oleada de estudios de replicaci√≥n con resultados heterog√©neos y ocasionalmente contradictorios, generando debate cient√≠fico intenso sobre la magnitud real, robustez y alcance de los efectos de transferencia del entrenamiento n-back.</p>

                <h4>üìä Soveri et al. (2017) - Meta-An√°lisis Comprehensivo</h4>
                <p>Integraci√≥n cuantitativa de <strong>33 estudios independientes</strong> (N total = 1,417 participantes) utilizando metodolog√≠a meta-anal√≠tica de efectos aleatorios (random-effects model) para estimar tama√±os del efecto poblacionales:</p>
                <ul>
                    <li><strong>Transferencia cercana (near transfer):</strong> Mejoras en otras tareas de memoria de trabajo no entrenadas (g = 0.52, IC 95%: 0.38-0.66) - efecto robusto y replicable</li>
                    <li><strong>Transferencia lejana a Gf (far transfer):</strong> Mejoras en inteligencia fluida (Hedge's g = 0.19, IC 95%: 0.03-0.35) - efecto peque√±o pero significativo, con heterogeneidad sustancial entre estudios (I¬≤ = 45%)</li>
                    <li><strong>Moderadores identificados:</strong> Dosis de entrenamiento (>20 sesiones), nivel de dificultad alcanzado, y caracter√≠sticas muestrales (mayor beneficio en participantes con capacidad basal baja-media)</li>
                </ul>

                <h4>üîç Au et al. (2015) - An√°lisis Cr√≠tico</h4>
                <p>Revisi√≥n sistem√°tica de 20 estudios con especial atenci√≥n a calidad metodol√≥gica (dise√±o, controles activos, cegamiento) revel√≥:</p>
                <ul>
                    <li>Estudios con controles activos (placebo cognitivo) muestran efectos m√°s peque√±os (g = 0.13) que estudios con controles pasivos (g = 0.28)</li>
                    <li>Evidencia de sesgo de publicaci√≥n (publication bias) - estudios con resultados nulos menos propensos a publicarse</li>
                    <li>Necesidad de protocolos m√°s rigurosos con cegamiento de evaluadores y expectativas controladas</li>
                </ul>

                <h4>‚úÖ Conclusi√≥n Consensuada (Shipstead et al., 2012; Melby-Lerv√•g & Hulme, 2013)</h4>
                <p>El entrenamiento n-back produce ganancias <em>consistentes y robustas</em> en:</p>
                <ul>
                    <li><strong>Tarea de criterio entrenada:</strong> Mejoras muy grandes (d = 1.0-1.5)</li>
                    <li><strong>Transferencia cercana:</strong> Otras tareas WM (g = 0.4-0.6)</li>
                </ul>

                <p>Evidencia de <strong>transferencia lejana a inteligencia fluida</strong> existe pero es <em>modesta</em> (g = 0.15-0.25), <em>variable entre individuos</em>, y requiere protocolos intensivos (>20 sesiones, 8+ semanas). Factores individuales (capacidad basal, motivaci√≥n, polimorfismos gen√©ticos) modulan sustancialmente efectos.</p>

                <div class="citation">
                    Soveri, A., Antfolk, J., Karlsson, L., Salo, B., & Laine, M. (2017). Working memory training revisited: A multi-level meta-analysis of n-back training studies. <em>Psychonomic Bulletin & Review, 24</em>(4), 1077-1096. https://doi.org/10.3758/s13423-016-1217-0
                    <br><br>
                    Au, J., Sheehan, E., Tsai, N., Duncan, G. J., Buschkuehl, M., & Jaeggi, S. M. (2015). Improving fluid intelligence with training on working memory: A meta-analysis. <em>Psychonomic Bulletin & Review, 22</em>(2), 366-377.
                    <br><br>
                    Shipstead, Z., Redick, T. S., & Engle, R. W. (2012). Is working memory training effective? <em>Psychological Bulletin, 138</em>(4), 628-654.
                </div>
            </div>

            <div class="academic-box info-box">
                <h3>3.3 Mecanismos Neuropl√°sticos: Cambios Estructurales y Funcionales</h3>
                <p>Estudios longitudinales que combinan entrenamiento cognitivo con neuroimagen estructural (morfometr√≠a basada en v√≥xeles - VBM) y funcional (fMRI) revelan que el entrenamiento n-back sostenido induce cambios mensurables y cuantificables en estructura y funci√≥n cerebral:</p>

                <h4>üß† Plasticidad Estructural</h4>
                <ul>
                    <li><strong>Incremento de densidad de materia gris:</strong> Takeuchi et al. (2010) reportaron aumentos significativos en corteza frontopolar bilateral (√°rea 10 de Brodmann) y corteza parietal posterior tras 8 semanas de entrenamiento WM adaptativo. Magnitud de cambio correlaciona con mejora conductual (r = 0.45-0.62)</li>
                    <li><strong>Expansi√≥n cortical:</strong> Incrementos locales en grosor cortical (cortical thickness) en DLPFC bilateral observados mediante an√°lisis superficie-a-superficie (surface-based morphometry)</li>
                    <li><strong>Mecanismos celulares subyacentes:</strong> Evidencia de estudios animales sugiere: (a) sinaptog√©nesis - formaci√≥n de nuevas sinapsis excitatorias, (b) angiog√©nesis - aumento de densidad vascular para soportar mayor demanda metab√≥lica, (c) expansi√≥n glial - proliferaci√≥n de astrocitos y oligodendrocitos</li>
                </ul>

                <h4>‚ö° Plasticidad Funcional</h4>
                <ul>
                    <li><strong>Eficiencia neural:</strong> Reducci√≥n de activaci√≥n DLPFC para mismo nivel de dificultad post-entrenamiento (Hempel et al., 2004) - procesamiento m√°s eficiente requiere menor reclutamiento de recursos neurales, an√°logo a "automatizaci√≥n cognitiva"</li>
                    <li><strong>Conectividad funcional fortalecida:</strong> Aumentos en sincronizaci√≥n fronto-parietal (correlaciones temporales BOLD) durante estados de reposo y tarea (Jolles et al., 2010; Takeuchi et al., 2010)</li>
                    <li><strong>Modulaci√≥n dopamin√©rgica:</strong> Polimorfismos en genes del sistema dopamin√©rgico (COMT Val158Met, DRD2) predicen magnitud de mejora individual (Brehmer et al., 2009; S√∂derqvist et al., 2012) - variantes asociadas a mayor disponibilidad dopamin√©rgica en DLPFC muestran mayor plasticidad</li>
                </ul>

                <div class="citation">
                    Takeuchi, H., Sekiguchi, A., Taki, Y., Yokoyama, S., Yomogida, Y., Komuro, N., ... & Kawashima, R. (2010). Training of working memory impacts structural connectivity. <em>Journal of Neuroscience, 30</em>(9), 3297-3303. https://doi.org/10.1523/JNEUROSCI.4115-09.2010
                    <br><br>
                    Jolles, D. D., van Buchem, M. A., Crone, E. A., & Rombouts, S. A. (2010). A comprehensive study of whole-brain functional connectivity in children and young adults. <em>Cerebral Cortex, 21</em>(2), 385-391.
                    <br><br>
                    Brehmer, Y., Westerberg, H., Bellander, M., F√ºrth, D., Karlsson, S., & B√§ckman, L. (2009). Working memory plasticity modulated by dopamine transporter genotype. <em>Neuroscience Letters, 467</em>(2), 117-120.
                </div>
            </div>

            <h2>IV. Relevancia Cl√≠nica: Aplicaciones en TDAH</h2>

            <div class="academic-box adhd-highlight">
                <h3>4.1 D√©ficits de Memoria de Trabajo en TDAH: Endofenotipo Cr√≠tico</h3>
                <p>El <strong>Trastorno por D√©ficit de Atenci√≥n e Hiperactividad (TDAH)</strong> representa uno de los trastornos del neurodesarrollo m√°s prevalentes a nivel global (prevalencia mundial: 5-7% poblaci√≥n infantil; 2.5-4% adultos seg√∫n Polanczyk et al., 2007; Faraone et al., 2015), caracterizado por d√©ficits persistentes, pervasivos y funcionalmente deteriorantes en tres dominios sintom√°ticos nucleares: inatenci√≥n sostenida, hiperactividad motora e impulsividad conductual.</p>

                <p>Crucialmente, investigaci√≥n neuropsicol√≥gica acumulada durante las √∫ltimas tres d√©cadas ha identificado d√©ficits robustos y replicables en <strong>memoria de trabajo (WM)</strong> como endofenotipo cognitivo central del TDAH, presente en aproximadamente 75-85% de casos diagnosticados y observable incluso en familiares no afectados (indicando heredabilidad del d√©ficit).</p>

                <h4>üìä Evidencia Meta-Anal√≠tica de D√©ficits WM</h4>
                <p><strong>Kasper et al. (2012):</strong> Meta-an√°lisis de 26 estudios controlados (N = 1,068 ni√±os TDAH vs. 1,056 controles neurot√≠picos)</p>
                <ul>
                    <li><strong>WM visuoespacial:</strong> d = -1.03 (IC 95%: -1.28 a -0.78) - magnitud de efecto <em>muy grande</em>. Aproximadamente 85% de ni√±os TDAH punt√∫an por debajo de la media del grupo control</li>
                    <li><strong>WM verbal:</strong> d = -0.73 (IC 95%: -0.88 a -0.58) - magnitud <em>grande</em></li>
                    <li>D√©ficits observados transversalmente en todos componentes del modelo de Baddeley: bucle fonol√≥gico, agenda visuoespacial y ejecutivo central</li>
                    <li>Magnitud de d√©ficit no explicada completamente por comorbilidades (ansiedad, TOD) o medicaci√≥n estimulante</li>
                </ul>

                <p><strong>Martinussen et al. (2005):</strong> An√°lisis comprehensivo de 26 estudios confirma d√©ficits generalizados en todos componentes de WM, con mayor deterioro en ejecutivo central (d = -0.89) que en sistemas esclavos (bucle fonol√≥gico d = -0.53, agenda visuoespacial d = -0.67)</p>

                <h4>üîó Causalidad vs. Epifen√≥meno: An√°lisis de Mediaci√≥n</h4>
                <p>Investigaci√≥n longitudinal sofisticada (Raiker et al., 2019; Martin et al., 2024) mediante an√°lisis de mediaci√≥n estad√≠stica y modelado de ecuaciones estructurales (SEM) demuestra que d√©ficits de WM en TDAH representan un <em>mecanismo causal proximal</em> que genera deterioros secundarios en m√∫ltiples dominios funcionales:</p>
                <ul>
                    <li><strong>Control inhibitorio:</strong> Dificultad para frenar respuestas prepotentes e impulsivas. WM media 40-55% de d√©ficits inhibitorios en TDAH</li>
                    <li><strong>Regulaci√≥n emocional:</strong> Baja tolerancia a frustraci√≥n, labilidad afectiva. Correlaci√≥n r = 0.45 entre capacidad WM y disregulaci√≥n emocional</li>
                    <li><strong>Rendimiento acad√©mico:</strong> Comprensi√≥n lectora, resoluci√≥n de problemas matem√°ticos, escritura. WM explica 25-35% de varianza en rendimiento escolar en TDAH</li>
                    <li><strong>Funcionamiento adaptativo:</strong> Habilidades de organizaci√≥n, planificaci√≥n y gesti√≥n del tiempo en vida cotidiana</li>
                </ul>

                <p>Estos hallazgos convergentes posicionan a WM como <strong>target terap√©utico primario</strong> en TDAH, potencialmente m√°s fundamental que s√≠ntomas superficiales de inatenci√≥n/hiperactividad.</p>

                <div class="citation">
                    Kasper, L. J., Alderson, R. M., & Hudec, K. L. (2012). Moderators of working memory deficits in children with attention-deficit/hyperactivity disorder (ADHD): A meta-analytic review. <em>Clinical Psychology Review, 32</em>(7), 605-617. https://doi.org/10.1016/j.cpr.2012.07.001
                    <br><br>
                    Martinussen, R., Hayden, J., Hogg-Johnson, S., & Tannock, R. (2005). A meta-analysis of working memory impairments in children with attention-deficit/hyperactivity disorder. <em>Journal of the American Academy of Child & Adolescent Psychiatry, 44</em>(4), 377-384.
                    <br><br>
                    Polanczyk, G., de Lima, M. S., Horta, B. L., Biederman, J., & Rohde, L. A. (2007). The worldwide prevalence of ADHD: A systematic review and metaregression analysis. <em>American Journal of Psychiatry, 164</em>(6), 942-948.
                </div>
            </div>

            <div class="academic-box success-box">
                <h3>4.2 Eficacia del Entrenamiento N-Back en TDAH: Evidencia de RCTs</h3>
                <p>Ensayos controlados aleatorizados (RCTs - Randomized Controlled Trials) de alta calidad metodol√≥gica han evaluado la eficacia del entrenamiento cognitivo tipo n-back como intervenci√≥n no farmacol√≥gica complementaria en poblaciones TDAH:</p>

                <h4>üìã Beck et al. (2010) - Estudio Piloto Controlado</h4>
                <ul>
                    <li><strong>Muestra:</strong> N = 25 ni√±os con TDAH (7-14 a√±os), dise√±o cruzado (crossover)</li>
                    <li><strong>Protocolo:</strong> 25 sesiones de dual n-back (5 semanas, 5 d√≠as/semana, ~25 min/sesi√≥n)</li>
                    <li><strong>Resultados primarios:</strong>
                        <ul>
                            <li>Mejoras significativas en tarea n-back entrenada (tama√±o efecto d = 1.2 vs. control)</li>
                            <li>Transferencia cercana a span complejo no entrenado (d = 0.6)</li>
                            <li>Transferencia a control inhibitorio: reducci√≥n errores de comisi√≥n en CPT (Continuous Performance Test) d = 0.5</li>
                            <li>Reducci√≥n modesta pero estad√≠sticamente significativa en s√≠ntomas TDAH reportados por padres (Conners' Rating Scale: d = 0.4)</li>
                        </ul>
                    </li>
                </ul>

                <h4>üìã Klingberg et al. (2005) - RCT Sueco Seminal</h4>
                <ul>
                    <li><strong>Muestra:</strong> N = 53 ni√±os TDAH (7-12 a√±os), asignaci√≥n aleatoria a entrenamiento adaptativo vs. control activo (entrenamiento no-adaptativo de baja dosis)</li>
                    <li><strong>Protocolo:</strong> 25 sesiones de entrenamiento WM (CogMed Working Memory Training - incluye tareas visuoespaciales y verbales)</li>
                    <li><strong>Resultados robustos:</strong>
                        <ul>
                            <li>Mejoras en span WM: d = 0.9 (grupo experimental vs. control)</li>
                            <li>Reducci√≥n cl√≠nicamente significativa de s√≠ntomas de inatenci√≥n: d = 0.7 (Conners' Parent Rating Scale - CPRS)</li>
                            <li><strong>Seguimiento a 3 meses:</strong> Efectos mantenidos sin pr√°ctica adicional (indicando consolidaci√≥n)</li>
                        </ul>
                    </li>
                </ul>

                <h4>‚ö†Ô∏è Limitaciones y Consideraciones Cr√≠ticas</h4>
                <p>Si bien resultados son prometedores y sugieren potencial terap√©utico, meta-an√°lisis recientes (Cortese et al., 2015; Rapport et al., 2013) y revisiones sistem√°ticas Cochrane advierten:</p>
                <ul>
                    <li><strong>Efectos sobre s√≠ntomas TDAH en vida cotidiana son modestos:</strong> g = 0.30-0.40 seg√∫n evaluaciones parentales; efectos menores o no significativos seg√∫n evaluaciones de profesores (menor sesgo expectativa)</li>
                    <li><strong>Transferencia lejana limitada:</strong> Transferencia a dominios cognitivos no entrenados requiere protocolos muy intensivos (>30 sesiones)</li>
                    <li><strong>Heterogeneidad de respuesta:</strong> 30-40% de participantes muestran mejoras m√≠nimas o nulas ("non-responders")</li>
                    <li><strong>Rol como intervenci√≥n adjunta:</strong> Entrenamiento cognitivo debe complementar (NO reemplazar) tratamientos evidence-based de primera l√≠nea: medicaci√≥n estimulante (metilfenidato, anfetaminas) y terapia conductual estructurada</li>
                    <li><strong>Adherencia cr√≠tica:</strong> Tasas de abandono (dropout) del 15-30% en estudios. Gamificaci√≥n y refuerzo positivo mejoran engagement significativamente</li>
                </ul>

                <div class="citation">
                    Beck, S. J., Hanson, C. A., Puffenberger, S. S., Benninger, K. L., & Benninger, W. B. (2010). A controlled trial of working memory training for children and adolescents with ADHD. <em>Journal of Clinical Child & Adolescent Psychology, 39</em>(6), 825-836. https://doi.org/10.1080/15374416.2010.517162
                    <br><br>
                    Klingberg, T., Fernell, E., Olesen, P. J., Johnson, M., Gustafsson, P., Dahlstr√∂m, K., ... & Westerberg, H. (2005). Computerized training of working memory in children with ADHD‚ÄîA randomized, controlled trial. <em>Journal of the American Academy of Child & Adolescent Psychiatry, 44</em>(2), 177-186.
                    <br><br>
                    Cortese, S., Ferrin, M., Brandeis, D., Buitelaar, J., Daley, D., Dittmann, R. W., ... & Sonuga-Barke, E. J. (2015). Cognitive training for attention-deficit/hyperactivity disorder: Meta-analysis of clinical and neuropsychological outcomes from randomized controlled trials. <em>Journal of the American Academy of Child & Adolescent Psychiatry, 54</em>(3), 164-174.
                </div>
            </div>

            <h2>V. Conclusiones y Recomendaciones Pr√°cticas Basadas en Evidencia</h2>

            <div class="academic-box info-box">
                <h3>S√≠ntesis de Evidencia Cient√≠fica</h3>
                <p>La literatura cient√≠fica convergente y acumulativa de las √∫ltimas dos d√©cadas establece las siguientes conclusiones robustas:</p>
                <ol>
                    <li>La memoria de trabajo es un sistema cognitivo <strong>entrenable y pl√°stico</strong> mediante pr√°ctica intensiva y adaptativa, contradiciendo nociones previas de inmutabilidad</li>
                    <li>El entrenamiento dual n-back produce mejoras <strong>robustas y replicables</strong> en tareas de criterio (d = 1.0-1.5) observables tras 8-12 sesiones</li>
                    <li>Transferencia cercana a otras tareas WM es <strong>consistente</strong> (g = 0.4-0.6) y se mantiene durante meses post-entrenamiento</li>
                    <li>Transferencia lejana a inteligencia fluida es <strong>peque√±a pero real</strong> (g = 0.15-0.25), dependiente de dosis (>20 sesiones) y moderada por factores individuales (capacidad basal, motivaci√≥n, gen√©tica)</li>
                    <li>Mecanismos neuropl√°sticos subyacentes incluyen <strong>cambios estructurales mensurables</strong> (densidad materia gris, grosor cortical) y <strong>funcionales</strong> (eficiencia neural, conectividad fronto-parietal fortalecida) en DLPFC y redes asociadas</li>
                    <li>Aplicaciones cl√≠nicas en TDAH son <strong>prometedoras como intervenci√≥n complementaria</strong>, no como monoterapia. Efectos modestos pero significativos sobre s√≠ntomas y funcionamiento cotidiano</li>
                </ol>
            </div>

            <div class="academic-box success-box">
                <h3>Protocolo √ìptimo Basado en S√≠ntesis de Literatura</h3>
                <p><strong>Para maximizar probabilidad de beneficios neurocognitivos:</strong></p>
                <ul>
                    <li><strong>Duraci√≥n m√≠nima:</strong> 8-12 semanas (20-30 sesiones totales). Protocolos <20 sesiones muestran efectos inconsistentes</li>
                    <li><strong>Frecuencia:</strong> 4-5 d√≠as/semana. Entrenamiento diario no superior a sesiones alternas (consolidaci√≥n requiere descanso)</li>
                    <li><strong>Duraci√≥n de sesi√≥n:</strong> 20-30 minutos. Sesiones >40 min asociadas a fatiga cognitiva y rendimiento deteriorado</li>
                    <li><strong>Adaptatividad cr√≠tica:</strong> Nivel de dificultad debe ajustarse continuamente seg√∫n desempe√±o individual para mantener desaf√≠o √≥ptimo (~70-85% precisi√≥n - "zona de desarrollo pr√≥ximo" cognitiva)</li>
                    <li><strong>Modalidad dual superior:</strong> Combinaci√≥n simult√°nea de est√≠mulos auditivos y visuoespaciales maximiza carga ejecutiva y transferencia vs. tareas unimodales</li>
                    <li><strong>Adherencia y consistencia:</strong> Interrupciones >3 d√≠as consecutivos comprometen efectos acumulativos. Establecer rutina fija horaria</li>
                    <li><strong>Ambiente controlado:</strong> Minimizar distracciones auditivas/visuales. Usar auriculares de calidad para discriminaci√≥n auditiva √≥ptima</li>
                    <li><strong>Expectativas realistas:</strong> Mejoras son graduales. Mesetas (plateaus) son normales y transitorias. Persistencia es clave. Efectos individualizados (respuesta variable)</li>
                    <li><strong>Mantenimiento post-programa:</strong> Reducir a 2-3 sesiones/semana tras 12 semanas para consolidar ganancias a largo plazo</li>
                </ul>
            </div>

            <div class="btn-group">
                <button class="btn btn-success" onclick="app.showLevelSelector()">üöÄ Comenzar Entrenamiento Cient√≠fico</button>
                <button class="btn btn-secondary" onclick="app.goHome()">üè† Volver al Men√∫</button>
            </div>
        </div>

    </div>

    <script>
        /**
         * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         * DUAL N-BACK PRO v3.0 - JAVASCRIPT ENGINE
         * Sistema de Entrenamiento Cognitivo Cient√≠fico de Grado Cl√≠nico
         * 
         * Fusi√≥n optimizada de:
         * - Motor de juego adaptativo de index.html
         * - Sistema de navegaci√≥n History API de Prueba.html
         * - Sistema de logros y gamificaci√≥n
         * - Wake Lock API para prevenir bloqueo de pantalla
         * - Base cient√≠fica expandida
         * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         */

        /**
         * GESTOR DE NAVEGACI√ìN CON HISTORY API
         * Permite usar bot√≥n "atr√°s" del navegador sin salir de la aplicaci√≥n
         */
        const navigationManager = {
            history: [],
            
            init() {
                // Estado inicial
                window.history.replaceState({ screen: 'screen-device' }, '', '#device');
                this.history.push('screen-device');

                // Interceptar bot√≥n atr√°s del navegador
                window.addEventListener('popstate', (event) => {
                    if (event.state && event.state.screen) {
                        const targetScreen = event.state.screen;
                        
                        // Confirmaci√≥n si est√° jugando
                        if (game.isPlaying) {
                            if (confirm('¬øSalir del entrenamiento actual?\n\nSe perder√° el progreso de esta sesi√≥n.')) {
                                game.stop();
                                app.showScreen(targetScreen, false);
                            } else {
                                // Restaurar estado del juego
                                window.history.pushState({ screen: 'screen-game' }, '', '#game');
                            }
                        } else {
                            app.showScreen(targetScreen, false);
                        }
                    } else {
                        app.goHome();
                    }
                });

                console.log('‚úÖ Navigation Manager inicializado');
            },

            push(screenId) {
                const hash = '#' + screenId.replace('screen-', '');
                window.history.pushState({ screen: screenId }, '', hash);
                this.history.push(screenId);
            }
        };

        /**
         * GENERADOR ALEATORIO AVANZADO
         * Algoritmo Mulberry32 para distribuci√≥n pseudo-aleatoria de alta calidad
         */
        class AdvancedRNG {
            constructor(seed = Date.now()) {
                this.seed = seed | 0;
            }

            // Mulberry32 - PRNG de alta calidad
            next() {
                let t = this.seed += 0x6D2B79F5;
                t = Math.imul(t ^ (t >>> 15), t | 1);
                t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
                return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
            }

            nextInt(min, max) {
                return Math.floor(this.next() * (max - min + 1)) + min;
            }

            shouldCreateMatch(nLevel, sequenceLength) {
                if (sequenceLength < nLevel) return false;
                const baseProbability = 0.35 + Math.min(nLevel * 0.015, 0.15);
                return this.next() < baseProbability;
            }

            getMatchType() {
                const rand = this.next();
                if (rand < 0.40) return 'position';
                if (rand < 0.80) return 'audio';
                return 'both';
            }

            reset() {
                this.seed = Date.now() + Math.random() * 1000000 | 0;
            }
        }

        /**
         * MOTOR DE AUDIO OPTIMIZADO
         * Compatible con iOS/Android/Desktop
         */
        const AudioEngine = {
            ctx: null,
            synth: window.speechSynthesis,
            voices: [],
            isUnlocked: false,
            currentOscillator: null,
            audioRetryCount: 0,
            maxRetries: 3,

            init() {
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContext();
                    console.log('üîä AudioContext creado:', this.ctx.state);
                } catch (e) {
                    console.warn('‚ö†Ô∏è Web Audio API no soportada:', e);
                }

                // Cargar voces con reintentos
                const loadVoices = () => {
                    this.voices = this.synth.getVoices();
                    if (this.voices.length > 0) {
                        console.log(`‚úÖ ${this.voices.length} voces cargadas`);
                    } else if (this.audioRetryCount < this.maxRetries) {
                        this.audioRetryCount++;
                        setTimeout(loadVoices, 100);
                    }
                };

                if (this.synth.onvoiceschanged !== undefined) {
                    this.synth.onvoiceschanged = loadVoices;
                }
                loadVoices();
            },

            // Desbloquear audio (cr√≠tico para iOS/Safari)
            unlock() {
                if (this.isUnlocked) return Promise.resolve();

                return new Promise((resolve) => {
                    // Resumir AudioContext si est√° suspendido
                    if (this.ctx && this.ctx.state === 'suspended') {
                        this.ctx.resume().then(() => {
                            console.log('üîä AudioContext desbloqueado');
                        });
                    }

                    // Reproducir buffer silencioso
                    if (this.ctx) {
                        try {
                            const osc = this.ctx.createOscillator();
                            const gain = this.ctx.createGain();
                            gain.gain.value = 0.001;
                            osc.connect(gain);
                            gain.connect(this.ctx.destination);
                            osc.start(0);
                            osc.stop(0.1);
                        } catch (e) {
                            console.warn('‚ö†Ô∏è Error desbloqueando audio:', e);
                        }
                    }

                    // Inicializar s√≠ntesis de voz
                    try {
                        const utterance = new SpeechSynthesisUtterance('');
                        utterance.volume = 0.01;
                        this.synth.speak(utterance);
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Error inicializando speech:', e);
                    }

                    this.isUnlocked = true;
                    console.log('‚úÖ Sistema de audio desbloqueado');
                    resolve();
                });
            },

            // Reproducir tono asociado a letra
            playTone(letter) {
                if (!this.ctx) return;

                if (this.currentOscillator) {
                    try { this.currentOscillator.stop(); } catch(e) {}
                }

                const freqMap = {
                    'C': 261.63, 'H': 293.66, 'K': 329.63, 'L': 349.23,
                    'Q': 392.00, 'R': 440.00, 'S': 493.88, 'T': 523.25
                };
                const freq = freqMap[letter] || 440;

                try {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();

                    osc.type = 'sine';
                    osc.frequency.value = freq;

                    const now = this.ctx.currentTime;
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(0.12, now + 0.05);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.35);

                    osc.connect(gain);
                    gain.connect(this.ctx.destination);

                    osc.start(now);
                    osc.stop(now + 0.4);

                    this.currentOscillator = osc;
                    setTimeout(() => { this.currentOscillator = null; }, 450);
                } catch (e) {
                    console.warn('‚ö†Ô∏è Error reproduciendo tono:', e);
                }
            },

            // S√≠ntesis de voz con fallback
            speak(letter) {
                // Cancelar s√≠ntesis previa
                this.synth.cancel();

                try {
                    const utterance = new SpeechSynthesisUtterance(letter);
                    utterance.rate = 1.1;
                    utterance.pitch = 1.0;
                    utterance.volume = 0.9;
                    utterance.lang = 'es-ES';

                    // Seleccionar voz espa√±ola
                    const esVoice = this.voices.find(v => v.lang.includes('es-ES')) ||
                                   this.voices.find(v => v.lang.includes('es'));
                    if (esVoice) utterance.voice = esVoice;

                    // Manejar errores
                    utterance.onerror = (event) => {
                        console.warn('‚ö†Ô∏è Error en speech synthesis:', event);
                        this.playTone(letter); // Fallback a tono
                    };

                    this.synth.speak(utterance);
                    
                    // Reproducir tono simult√°neamente
                    setTimeout(() => this.playTone(letter), 50);
                } catch (e) {
                    console.warn('‚ö†Ô∏è Error en speak:', e);
                    this.playTone(letter); // Fallback
                }
            },

            stop() {
                try {
                    this.synth.cancel();
                } catch (e) {}
                
                if (this.currentOscillator) {
                    try { 
                        this.currentOscillator.stop(); 
                    } catch(e) {}
                    this.currentOscillator = null;
                }
            }
        };

        /**
         * SISTEMA DE LOGROS Y GAMIFICACI√ìN
         */
        const achievements = {
            enabled: true,
            
            list: {
                first_session: {
                    id: 'first_session',
                    name: 'üéØ Primera Sesi√≥n',
                    description: 'Completaste tu primera sesi√≥n de entrenamiento',
                    unlocked: false,
                    medal: 'ü•â'
                },
                level_3: {
                    id: 'level_3',
                    name: 'üß† Cerebro en Expansi√≥n',
                    description: 'Alcanzaste el nivel 3-Back',
                    unlocked: false,
                    medal: 'ü•à'
                },
                level_5: {
                    id: 'level_5',
                    name: 'üöÄ Experto Cognitivo',
                    description: 'Alcanzaste el nivel 5-Back',
                    unlocked: false,
                    medal: 'ü•á'
                },
                perfect_session: {
                    id: 'perfect_session',
                    name: 'üíØ Precisi√≥n Perfecta',
                    description: 'Completaste una sesi√≥n con 100% de precisi√≥n',
                    unlocked: false,
                    medal: '‚≠ê'
                },
                streak_5: {
                    id: 'streak_5',
                    name: 'üî• Racha de 5 D√≠as',
                    description: 'Entrenaste durante 5 d√≠as consecutivos',
                    unlocked: false,
                    medal: 'üî•'
                },
                streak_15: {
                    id: 'streak_15',
                    name: '‚ö° Racha de 15 D√≠as',
                    description: 'Entrenaste durante 15 d√≠as consecutivos',
                    unlocked: false,
                    medal: '‚ö°'
                },
                total_50: {
                    id: 'total_50',
                    name: 'üìö 50 Sesiones',
                    description: 'Completaste 50 sesiones totales de entrenamiento',
                    unlocked: false,
                    medal: 'üìö'
                },
                accuracy_90: {
                    id: 'accuracy_90',
                    name: 'üéì Maestr√≠a Cognitiva',
                    description: 'Alcanzaste 90% de precisi√≥n o m√°s',
                    unlocked: false,
                    medal: 'üéì'
                },
                level_10: {
                    id: 'level_10',
                    name: 'üëë √âlite Cognitiva',
                    description: 'Alcanzaste el nivel 10-Back (percentil 99)',
                    unlocked: false,
                    medal: 'üëë'
                }
            },

            load() {
                try {
                    const saved = JSON.parse(localStorage.getItem('nback_achievements') || '{}');
                    Object.keys(saved).forEach(key => {
                        if (this.list[key]) {
                            this.list[key].unlocked = saved[key];
                        }
                    });
                } catch (e) {
                    console.warn('Error cargando logros:', e);
                }
            },

            save() {
                try {
                    const toSave = {};
                    Object.keys(this.list).forEach(key => {
                        toSave[key] = this.list[key].unlocked;
                    });
                    localStorage.setItem('nback_achievements', JSON.stringify(toSave));
                } catch (e) {
                    console.warn('Error guardando logros:', e);
                }
            },

            check(sessionData, history) {
                if (!this.enabled) return;

                const newUnlocks = [];

                // Primera sesi√≥n
                if (!this.list.first_session.unlocked && history.length === 1) {
                    this.unlock('first_session');
                    newUnlocks.push(this.list.first_session);
                }

                // Nivel 3
                if (!this.list.level_3.unlocked && sessionData.level >= 3) {
                    this.unlock('level_3');
                    newUnlocks.push(this.list.level_3);
                }

                // Nivel 5
                if (!this.list.level_5.unlocked && sessionData.level >= 5) {
                    this.unlock('level_5');
                    newUnlocks.push(this.list.level_5);
                }

                // Nivel 10
                if (!this.list.level_10.unlocked && sessionData.level >= 10) {
                    this.unlock('level_10');
                    newUnlocks.push(this.list.level_10);
                }

                // Precisi√≥n perfecta
                if (!this.list.perfect_session.unlocked && sessionData.accuracy === 100) {
                    this.unlock('perfect_session');
                    newUnlocks.push(this.list.perfect_session);
                }

                // Precisi√≥n 90%+
                if (!this.list.accuracy_90.unlocked && sessionData.accuracy >= 90) {
                    this.unlock('accuracy_90');
                    newUnlocks.push(this.list.accuracy_90);
                }

                // 50 sesiones totales
                if (!this.list.total_50.unlocked && history.length >= 50) {
                    this.unlock('total_50');
                    newUnlocks.push(this.list.total_50);
                }

                // Rachas (calcular d√≠as consecutivos)
                const streak = this.calculateStreak(history);
                if (!this.list.streak_5.unlocked && streak >= 5) {
                    this.unlock('streak_5');
                    newUnlocks.push(this.list.streak_5);
                }
                if (!this.list.streak_15.unlocked && streak >= 15) {
                    this.unlock('streak_15');
                    newUnlocks.push(this.list.streak_15);
                }

                // Notificar nuevos logros
                newUnlocks.forEach((achievement, index) => {
                    setTimeout(() => this.notify(achievement), index * 500);
                });
            },

            unlock(achievementId) {
                if (this.list[achievementId]) {
                    this.list[achievementId].unlocked = true;
                    this.save();
                    console.log('üèÜ Logro desbloqueado:', achievementId);
                }
            },

            notify(achievement) {
                const notification = document.createElement('div');
                notification.className = 'achievement-notification';
                notification.innerHTML = `
                    <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">${achievement.medal}</div>
                    <div style="font-weight: 700; font-size: 1.2rem; margin-bottom: 0.3rem;">¬°Logro Desbloqueado!</div>
                    <div style="font-size: 1rem; font-weight: 600;">${achievement.name}</div>
                    <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.3rem;">${achievement.description}</div>
                `;

                document.body.appendChild(notification);

                // Vibraci√≥n si est√° disponible
                if ('vibrate' in navigator) {
                    navigator.vibrate([100, 50, 100]);
                }

                // Eliminar despu√©s de 5 segundos
                setTimeout(() => {
                    notification.style.animation = 'slideOutRight 0.5s ease-out';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 500);
                }, 5000);
            },

            calculateStreak(history) {
                if (history.length === 0) return 0;

                // Ordenar por fecha
                const sorted = history.slice().sort((a, b) => 
                    new Date(b.date) - new Date(a.date)
                );

                let streak = 1;
                let currentDate = new Date(sorted[0].date);
                currentDate.setHours(0, 0, 0, 0);

                for (let i = 1; i < sorted.length; i++) {
                    const sessionDate = new Date(sorted[i].date);
                    sessionDate.setHours(0, 0, 0, 0);

                    const diffDays = Math.floor((currentDate - sessionDate) / (1000 * 60 * 60 * 24));

                    if (diffDays === 1) {
                        streak++;
                        currentDate = sessionDate;
                    } else if (diffDays > 1) {
                        break;
                    }
                }

                return streak;
            },

            getProgress() {
                const total = Object.keys(this.list).length;
                const unlocked = Object.values(this.list).filter(a => a.unlocked).length;
                return { unlocked, total, percentage: Math.round((unlocked / total) * 100) };
            }
        };

        /**
         * WAKE LOCK API
         * Previene que la pantalla se apague durante el entrenamiento
         */
        const wakeLockManager = {
            wakeLock: null,
            isSupported: 'wakeLock' in navigator,

            async request() {
                if (!this.isSupported) {
                    console.log('‚ö†Ô∏è Wake Lock API no soportada');
                    return false;
                }

                try {
                    this.wakeLock = await navigator.wakeLock.request('screen');
                    console.log('üîí Wake Lock activado');

                    // Manejar visibilidad
                    this.wakeLock.addEventListener('release', () => {
                        console.log('üîì Wake Lock liberado');
                    });

                    // Re-adquirir cuando la p√°gina vuelve a ser visible
                    document.addEventListener('visibilitychange', async () => {
                        if (document.visibilityState === 'visible' && game.isPlaying) {
                            await this.request();
                        }
                    });

                    return true;
                } catch (err) {
                    console.warn('‚ùå Error activando Wake Lock:', err);
                    return false;
                }
            },

            async release() {
                if (this.wakeLock) {
                    try {
                        await this.wakeLock.release();
                        this.wakeLock = null;
                        console.log('üîì Wake Lock liberado manualmente');
                    } catch (err) {
                        console.warn('Error liberando Wake Lock:', err);
                    }
                }
            }
        };

        /**
         * MOTOR DEL JUEGO - DUAL N-BACK
         */
        const game = {
            // Estado
            level: 1,
            rounds: 20,
            currentRound: 0,
            sequence: [],
            isPlaying: false,
            timer: null,
            autoSaveInterval: null,

            // Input del usuario
            currentInput: { pos: false, audio: false, timestamp: 0 },

            // Estad√≠sticas
            stats: { hits: 0, errors: 0, totalTargets: 0, responseTimes: [] },

            // Configuraci√≥n
            config: { zen: false, fast: false, intervalTime: 3000 },

            // RNG
            rng: new AdvancedRNG(),

            // Letras
            letters: ['C', 'H', 'K', 'L', 'Q', 'R', 'S', 'T'],

            // Historial reciente para evitar repeticiones
            recentPositions: [],
            recentLetters: [],

            async start(level) {
                this.level = level;
                this.currentRound = 0;
                this.sequence = [];
                this.isPlaying = true;
                this.recentPositions = [];
                this.recentLetters = [];

                this.stats = { hits: 0, errors: 0, totalTargets: 0, responseTimes: [] };
                this.config.intervalTime = this.config.fast ? 1500 : 3000;
                this.rng.reset();

                // Activar Wake Lock
                await wakeLockManager.request();

                // UI
                document.getElementById('game-level-badge').textContent = `Nivel ${this.level}-Back`;
                document.getElementById('game-mode-badge').style.display = this.config.fast ? 'inline-block' : 'none';
                document.getElementById('score-hits').textContent = '0';
                document.getElementById('score-errors').textContent = '0';
                document.getElementById('game-round').textContent = '0';
                document.getElementById('game-max-rounds').textContent = this.rounds;

                // Modo Zen
                if (this.config.zen) {
                    document.body.classList.add('zen-mode');
                } else {
                    document.body.classList.remove('zen-mode');
                }

                this.generateGrid();
                
                // Auto-guardado cada 10 segundos
                this.autoSaveInterval = setInterval(() => {
                    this.saveProgress();
                }, 10000);

                setTimeout(() => this.nextRound(), 1000);
            },

            generateGrid() {
                const container = document.getElementById('game-grid');
                container.innerHTML = '';
                for (let i = 0; i < 9; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.id = `cell-${i}`;
                    container.appendChild(cell);
                }
            },

            nextRound() {
                if (!this.isPlaying) return;

                if (this.currentRound > 0) {
                    this.evaluatePreviousRound();
                }

                if (this.currentRound >= this.rounds) {
                    this.finish();
                    return;
                }

                // Generar est√≠mulo
                const shouldMatch = this.rng.shouldCreateMatch(this.level, this.sequence.length);
                let pos, letter, matchPos = false, matchAudio = false;

                if (shouldMatch && this.sequence.length >= this.level) {
                    const targetIdx = this.sequence.length - this.level;
                    const target = this.sequence[targetIdx];
                    const matchType = this.rng.getMatchType();

                    if (matchType === 'position') {
                        pos = target.pos;
                        letter = this.getRandomLetter(true);
                        matchPos = true;
                    } else if (matchType === 'audio') {
                        pos = this.getRandomPosition(true);
                        letter = target.letter;
                        matchAudio = true;
                    } else {
                        pos = target.pos;
                        letter = target.letter;
                        matchPos = true;
                        matchAudio = true;
                    }
                } else {
                    pos = this.getRandomPosition(true);
                    letter = this.getRandomLetter(true);

                    if (this.sequence.length >= this.level) {
                        const targetIdx = this.sequence.length - this.level;
                        const target = this.sequence[targetIdx];
                        if (target.pos === pos) matchPos = true;
                        if (target.letter === letter) matchAudio = true;
                    }
                }

                this.sequence.push({
                    pos, letter, matchPos, matchAudio,
                    userInputPos: false, userInputAudio: false, inputTimestamp: 0
                });

                this.currentInput = { pos: false, audio: false, timestamp: Date.now() };
                this.showStimulus(pos, letter);
                this.currentRound++;
                document.getElementById('game-round').textContent = this.currentRound;

                this.timer = setTimeout(() => {
                    this.hideStimulus();
                    setTimeout(() => this.nextRound(), 500);
                }, this.config.intervalTime);
            },

            getRandomPosition(avoidRecent = true) {
                let pos, attempts = 0;
                do {
                    pos = this.rng.nextInt(0, 8);
                    attempts++;
                } while (avoidRecent && this.recentPositions.length > 0 && 
                         pos === this.recentPositions[this.recentPositions.length - 1] && 
                         attempts < 10);

                this.recentPositions.push(pos);
                if (this.recentPositions.length > 3) this.recentPositions.shift();
                return pos;
            },

            getRandomLetter(avoidRecent = true) {
                let letter, attempts = 0;
                do {
                    const idx = this.rng.nextInt(0, this.letters.length - 1);
                    letter = this.letters[idx];
                    attempts++;
                } while (avoidRecent && this.recentLetters.length > 0 && 
                         letter === this.recentLetters[this.recentLetters.length - 1] && 
                         attempts < 10);

                this.recentLetters.push(letter);
                if (this.recentLetters.length > 3) this.recentLetters.shift();
                return letter;
            },

            showStimulus(pos, letter) {
                this.hideStimulus();
                const cell = document.getElementById(`cell-${pos}`);
                if (cell) cell.classList.add('active');

                AudioEngine.speak(letter);
                document.getElementById('audio-indicator').textContent = `üîä ${letter}`;
            },

            hideStimulus() {
                document.querySelectorAll('.grid-cell').forEach(cell => cell.classList.remove('active'));
                document.getElementById('audio-indicator').textContent = 'üéß Escucha atentamente...';
            },

            handleInput(type) {
                if (!this.isPlaying || this.sequence.length === 0) return;

                const currentIdx = this.sequence.length - 1;
                const rt = Date.now() - this.currentInput.timestamp;

                if (type === 'pos') {
                    this.currentInput.pos = true;
                    this.sequence[currentIdx].userInputPos = true;
                    this.sequence[currentIdx].inputTimestamp = rt;
                } else if (type === 'audio') {
                    this.currentInput.audio = true;
                    this.sequence[currentIdx].userInputAudio = true;
                    this.sequence[currentIdx].inputTimestamp = rt;
                }

                // Feedback visual
                if (!this.config.zen) {
                    const btnId = app.device === 'desktop' ? 
                        (type === 'pos' ? 'btn-pos-desk' : 'btn-audio-desk') :
                        (type === 'pos' ? 'btn-pos-mobile' : 'btn-audio-mobile');
                    const btn = document.getElementById(btnId);
                    if (btn) {
                        btn.classList.add('matched');
                        setTimeout(() => btn.classList.remove('matched'), 300);
                    }
                }

                // Feedback h√°ptico
                if (app.device === 'mobile' && 'vibrate' in navigator) {
                    navigator.vibrate(30);
                }

                if (rt > 0 && rt < this.config.intervalTime) {
                    this.stats.responseTimes.push(rt);
                }
            },

            evaluatePreviousRound() {
                const idx = this.sequence.length - 1;
                if (idx < this.level) return;

                const round = this.sequence[idx];

                // Evaluar posici√≥n
                if (round.matchPos) {
                    if (round.userInputPos) {
                        this.stats.hits++;
                    } else {
                        this.stats.errors++;
                    }
                    this.stats.totalTargets++;
                } else {
                    if (round.userInputPos) {
                        this.stats.errors++;
                    }
                }

                // Evaluar audio
                if (round.matchAudio) {
                    if (round.userInputAudio) {
                        this.stats.hits++;
                    } else {
                        this.stats.errors++;
                    }
                    this.stats.totalTargets++;
                } else {
                    if (round.userInputAudio) {
                        this.stats.errors++;
                    }
                }

                if (!this.config.zen) {
                    document.getElementById('score-hits').textContent = this.stats.hits;
                    document.getElementById('score-errors').textContent = this.stats.errors;
                }
            },

            saveProgress() {
                if (!this.isPlaying) return;
                
                try {
                    const progress = {
                        level: this.level,
                        round: this.currentRound,
                        stats: this.stats,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('nback_progress', JSON.stringify(progress));
                } catch (e) {
                    console.warn('Error guardando progreso:', e);
                }
            },

            finish() {
                this.isPlaying = false;
                clearTimeout(this.timer);
                clearInterval(this.autoSaveInterval);
                AudioEngine.stop();
                wakeLockManager.release();

                localStorage.removeItem('nback_progress');

                const totalResponses = this.stats.hits + this.stats.errors;
                const accuracy = totalResponses > 0 ? Math.round((this.stats.hits / totalResponses) * 100) : 0;
                const avgLatency = this.stats.responseTimes.length > 0 ?
                    Math.round(this.stats.responseTimes.reduce((a, b) => a + b, 0) / this.stats.responseTimes.length) : 0;

                const sessionData = {
                    level: this.level,
                    accuracy: accuracy,
                    hits: this.stats.hits,
                    errors: this.stats.errors,
                    avgLatency: avgLatency,
                    mode: this.config.fast ? 'fast' : 'standard',
                    zen: this.config.zen,
                    date: new Date().toISOString()
                };

                app.saveSession(sessionData);
                app.showResults(sessionData);
            },

            stop() {
                this.isPlaying = false;
                clearTimeout(this.timer);
                clearInterval(this.autoSaveInterval);
                AudioEngine.stop();
                wakeLockManager.release();
                this.hideStimulus();
                localStorage.removeItem('nback_progress');
            }
        };

        /**
         * CONTROLADOR PRINCIPAL DE APLICACI√ìN
         */
        const app = {
            device: null,
            selectedLevel: 1,
            maxLevelReached: 1,
            resultChart: null,
            historyChart: null,

            init() {
                this.loadConfig();
                this.loadMaxLevel();
                achievements.load();
                AudioEngine.init();
                navigationManager.init();

                const savedDevice = localStorage.getItem('nback_device');
                if (savedDevice) {
                    this.device = savedDevice;
                    this.setupControls();
                }

                // Detectar modo oscuro del sistema
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    const savedDarkMode = localStorage.getItem('nback_darkmode');
                    if (savedDarkMode === 'true') {
                        document.body.classList.add('dark-mode');
                        document.getElementById('toggle-darkmode-config').checked = true;
                    }
                }

                // Controles de teclado
                document.addEventListener('keydown', (e) => {
                    if (this.device === 'desktop' && game.isPlaying) {
                        if (e.key === 'ArrowUp') {
                            e.preventDefault();
                            game.handleInput('pos');
                        } else if (e.key === 'ArrowDown') {
                            e.preventDefault();
                            game.handleInput('audio');
                        }
                    }
                });

                // Recuperar progreso si existe
                this.checkSavedProgress();

                console.log('‚úÖ Dual N-Back Pro v3.0 inicializado');
            },

            selectDevice(type) {
                this.device = type;
                localStorage.setItem('nback_device', type);
                AudioEngine.unlock();
                this.setupControls();
                this.showScreen('screen-home');
            },

            setupControls() {
                const desktopControls = document.getElementById('desktop-controls');
                const mobileControls = document.getElementById('mobile-controls');

                if (this.device === 'desktop') {
                    desktopControls.style.display = 'flex';
                    mobileControls.style.display = 'none';
                    document.getElementById('controls-type').textContent = 'Computador (Teclado)';
                    document.getElementById('controls-list').innerHTML = `
                        <li><strong>‚ñ≤ Flecha Arriba (‚Üë):</strong> Marcar coincidencia de POSICI√ìN visual</li>
                        <li><strong>‚ñº Flecha Abajo (‚Üì):</strong> Marcar coincidencia de SONIDO auditivo</li>
                        <li><strong>‚ñ≤ + ‚ñº Simult√°neas:</strong> Puedes presionar ambas teclas a la vez si ambas modalidades coinciden</li>
                    `;
                } else {
                    desktopControls.style.display = 'none';
                    mobileControls.style.display = 'grid';
                    document.getElementById('controls-type').textContent = 'Smartphone (T√°ctil)';
                    document.getElementById('controls-list').innerHTML = `
                        <li><strong>Bot√≥n "Posici√≥n":</strong> Marcar coincidencia de POSICI√ìN visual</li>
                        <li><strong>Bot√≥n "Sonido":</strong> Marcar coincidencia de SONIDO auditivo</li>
                        <li><strong>Ambos botones:</strong> Puedes presionar ambos simult√°neamente si es necesario</li>
                    `;
                }
            },

            showScreen(screenId, addToHistory = true) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });

                const screen = document.getElementById(screenId);
                if (screen) {
                    screen.classList.add('active');
                    document.querySelector('.app-container').scrollTop = 0;
                }

                // Actualizar botones flotantes
                const homeBtn = document.querySelector('.home-btn-fixed');
                const darkModeBtn = document.querySelector('.dark-mode-toggle');
                
                if (screenId === 'screen-device') {
                    homeBtn.style.display = 'none';
                    darkModeBtn.style.display = 'none';
                } else {
                    homeBtn.style.display = 'flex';
                    darkModeBtn.style.display = 'flex';
                }

                // Agregar al historial del navegador
                if (addToHistory) {
                    navigationManager.push(screenId);
                }

                // Actualizar display de logros si es pantalla de historial
                if (screenId === 'screen-history') {
                    this.showHistoryForLevel('all');
                    this.displayAchievements();
                }
            },

            goHome() {
                if (game.isPlaying) {
                    if (confirm('¬øSalir del entrenamiento?\n\nSe perder√° el progreso de la sesi√≥n actual.')) {
                        game.stop();
                        this.showScreen('screen-home');
                    }
                } else {
                    this.showScreen('screen-home');
                }
            },

            showLevelSelector() {
                this.showScreen('screen-level-select');
                this.renderLevelSelector();
            },

            renderLevelSelector() {
                const container = document.getElementById('level-selector');
                container.innerHTML = '';
                document.getElementById('max-level-reached').textContent = this.maxLevelReached;

                for (let i = 1; i <= 10; i++) {
                    const btn = document.createElement('div');
                    btn.className = 'level-btn';

                    if (i <= this.maxLevelReached) {
                        btn.textContent = i;
                        if (i === this.selectedLevel) {
                            btn.classList.add('selected');
                        }
                        btn.onclick = () => {
                            this.selectedLevel = i;
                            this.renderLevelSelector();
                        };
                    } else {
                        btn.textContent = 'üîí';
                        btn.classList.add('locked');
                        const small = document.createElement('small');
                        small.textContent = `${i}-Back`;
                        btn.appendChild(document.createElement('br'));
                        btn.appendChild(small);
                    }

                    container.appendChild(btn);
                }
            },

            startGameWithSelectedLevel() {
                if (!this.selectedLevel) {
                    alert('‚ö†Ô∏è Selecciona un nivel primero');
                    return;
                }

                AudioEngine.unlock();
                this.showScreen('screen-game');
                setTimeout(() => game.start(this.selectedLevel), 500);
            },

            quitGame() {
                if (confirm('¬øSalir del entrenamiento?\n\nSe perder√° el progreso de esta sesi√≥n.')) {
                    game.stop();
                    this.goHome();
                }
            },

            checkSavedProgress() {
                try {
                    const saved = localStorage.getItem('nback_progress');
                    if (saved) {
                        const progress = JSON.parse(saved);
                        const elapsed = Date.now() - progress.timestamp;
                        
                        // Si hace menos de 10 minutos
                        if (elapsed < 10 * 60 * 1000) {
                            if (confirm('Se detect√≥ una sesi√≥n interrumpida.\n¬øDeseas recuperar el progreso?')) {
                                // Aqu√≠ podr√≠as implementar recuperaci√≥n de sesi√≥n
                                console.log('Progreso recuperado:', progress);
                            }
                        }
                        localStorage.removeItem('nback_progress');
                    }
                } catch (e) {
                    console.warn('Error chequeando progreso:', e);
                }
            },

            loadMaxLevel() {
                const history = this.getHistory();
                if (history.length > 0) {
                    const successfulSessions = history.filter(s => s.accuracy >= 85);
                    if (successfulSessions.length > 0) {
                        const maxSuccessLevel = Math.max(...successfulSessions.map(s => s.level));
                        this.maxLevelReached = Math.min(10, maxSuccessLevel + 1);
                    } else {
                        this.maxLevelReached = 1;
                    }
                } else {
                    this.maxLevelReached = 1;
                }
                this.selectedLevel = this.maxLevelReached;
            },

            loadConfig() {
                try {
                    const config = JSON.parse(localStorage.getItem('nback_config') || '{}');
                    game.config.zen = config.zen || false;
                    game.config.fast = config.fast || false;
                    achievements.enabled = config.achievements !== false;
                    
                    document.getElementById('toggle-zen').checked = game.config.zen;
                    document.getElementById('toggle-fast').checked = game.config.fast;
                    document.getElementById('toggle-achievements').checked = achievements.enabled;
                } catch (e) {
                    console.warn('Error cargando config:', e);
                }
            },

            saveConfig() {
                localStorage.setItem('nback_config', JSON.stringify({
                    zen: game.config.zen,
                    fast: game.config.fast,
                    achievements: achievements.enabled
                }));
            },

            toggleZen() {
                game.config.zen = document.getElementById('toggle-zen').checked;
                this.saveConfig();
            },

            toggleFast() {
                game.config.fast = document.getElementById('toggle-fast').checked;
                this.saveConfig();
            },

            toggleAchievements() {
                achievements.enabled = document.getElementById('toggle-achievements').checked;
                this.saveConfig();
            },

            toggleDarkMode() {
                document.body.classList.toggle('dark-mode');
                const isDark = document.body.classList.contains('dark-mode');
                localStorage.setItem('nback_darkmode', isDark);
                
                const toggle = document.getElementById('toggle-darkmode-config');
                if (toggle) toggle.checked = isDark;
            },

            getHistory() {
                try {
                    return JSON.parse(localStorage.getItem('nback_history') || '[]');
                } catch (e) {
                    return [];
                }
            },

            saveSession(sessionData) {
                try {
                    const history = this.getHistory();
                    history.push(sessionData);
                    localStorage.setItem('nback_history', JSON.stringify(history));
                    this.loadMaxLevel();
                    
                    // Verificar logros
                    achievements.check(sessionData, history);
                    
                    console.log('üíæ Sesi√≥n guardada:', sessionData);
                } catch (e) {
                    console.error('Error guardando sesi√≥n:', e);
                }
            },

            showResults(data) {
                this.showScreen('screen-results');

                document.getElementById('result-accuracy').textContent = data.accuracy + '%';
                document.getElementById('result-level').textContent = data.level;
                document.getElementById('result-hits').textContent = data.hits;
                document.getElementById('result-errors').textContent = data.errors;

                const verdictDiv = document.getElementById('result-verdict');

                if (data.accuracy >= 85) {
                    verdictDiv.innerHTML = `
                        <div style="color: var(--success); font-size: 1.5rem; margin-bottom: 0.5rem;">üåü ¬°Excelente Desempe√±o Neurocognitivo!</div>
                        <p style="margin: 0;">Has alcanzado el umbral cl√≠nico del 85% seg√∫n criterio de Jaeggi et al. (2010). Tu cerebro demuestra neuroplasticidad adaptativa efectiva.</p>
                    `;
                    verdictDiv.className = 'academic-box success-box';
                } else if (data.accuracy >= 70) {
                    verdictDiv.innerHTML = `
                        <div style="color: var(--warning); font-size: 1.5rem; margin-bottom: 0.5rem;">‚öñÔ∏è Buen Progreso - Consolidaci√≥n</div>
                        <p style="margin: 0;">Est√°s en fase de consolidaci√≥n del aprendizaje. Contin√∫a entrenando en este nivel. Necesitas ‚â•85% para avanzar de manera √≥ptima.</p>
                    `;
                    verdictDiv.className = 'academic-box';
                    verdictDiv.style.borderLeftColor = 'var(--warning)';
                    verdictDiv.style.background = '#fff3e0';
                } else {
                    verdictDiv.innerHTML = `
                        <div style="color: var(--error); font-size: 1.5rem; margin-bottom: 0.5rem;">üìâ Sobrecarga Cognitiva Detectada</div>
                        <p style="margin: 0;">Este nivel excede tu capacidad actual de memoria de trabajo. Considera entrenar en un nivel inferior para optimizar el aprendizaje neuropl√°stico.</p>
                    `;
                    verdictDiv.className = 'academic-box';
                    verdictDiv.style.borderLeftColor = 'var(--error)';
                    verdictDiv.style.background = '#ffebee';
                }

                this.createResultChart(data);

                const buttonsDiv = document.getElementById('result-buttons');
                buttonsDiv.innerHTML = '';

                if (data.accuracy >= 85 && data.level < 10) {
                    const btnNext = document.createElement('button');
                    btnNext.className = 'btn btn-success';
                    btnNext.innerHTML = 'üöÄ Avanzar a Nivel ' + (data.level + 1);
                    btnNext.onclick = () => {
                        this.selectedLevel = data.level + 1;
                        this.maxLevelReached = Math.max(this.maxLevelReached, data.level + 1);
                        this.showScreen('screen-game');
                        setTimeout(() => game.start(this.selectedLevel), 500);
                    };
                    buttonsDiv.appendChild(btnNext);
                }

                const btnRetry = document.createElement('button');
                btnRetry.className = 'btn btn-warning';
                btnRetry.innerHTML = 'üîÑ Repetir Nivel ' + data.level;
                btnRetry.onclick = () => {
                    this.selectedLevel = data.level;
                    this.showScreen('screen-game');
                    setTimeout(() => game.start(this.selectedLevel), 500);
                };
                buttonsDiv.appendChild(btnRetry);

                const btnSelect = document.createElement('button');
                btnSelect.className = 'btn';
                btnSelect.innerHTML = 'üìä Elegir Nivel';
                btnSelect.onclick = () => this.showLevelSelector();
                buttonsDiv.appendChild(btnSelect);

                const btnHome = document.createElement('button');
                btnHome.className = 'btn btn-secondary';
                btnHome.innerHTML = 'üè† Men√∫ Principal';
                btnHome.onclick = () => this.goHome();
                buttonsDiv.appendChild(btnHome);
            },

            createResultChart(data) {
                const ctx = document.getElementById('result-chart');
                if (this.resultChart) this.resultChart.destroy();

                this.resultChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Aciertos', 'Errores'],
                        datasets: [{
                            data: [data.hits, data.errors],
                            backgroundColor: ['rgba(76, 175, 80, 0.8)', 'rgba(244, 67, 54, 0.8)'],
                            borderColor: ['rgba(76, 175, 80, 1)', 'rgba(244, 67, 54, 1)'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { position: 'bottom' },
                            title: {
                                display: true,
                                text: `Nivel ${data.level}-Back | Precisi√≥n: ${data.accuracy}%`
                            }
                        }
                    }
                });
            },

            showHistoryForLevel(levelFilter) {
                const history = this.getHistory();
                const filtered = levelFilter === 'all' ? history : history.filter(s => s.level === levelFilter);

                const summaryDiv = document.getElementById('history-summary');
                summaryDiv.innerHTML = '';

                if (history.length === 0) {
                    summaryDiv.innerHTML = '<div class="academic-box info-box"><p style="text-align: center; margin: 0;">Sin datos de entrenamiento a√∫n. Comienza tu primera sesi√≥n para ver estad√≠sticas.</p></div>';
                    document.getElementById('history-table-container').innerHTML = '';
                    if (this.historyChart) {
                        this.historyChart.destroy();
                        document.getElementById('history-chart').parentElement.style.display = 'none';
                    }
                    return;
                }

                const totalSessions = history.length;
                const avgAccuracy = Math.round(history.reduce((sum, s) => sum + s.accuracy, 0) / totalSessions);
                const maxLevel = Math.max(...history.map(s => s.level));
                const progress = achievements.getProgress();

                summaryDiv.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${totalSessions}</div>
                        <div class="stat-label">Sesiones Totales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${avgAccuracy}%</div>
                        <div class="stat-label">Precisi√≥n Media</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${maxLevel}</div>
                        <div class="stat-label">Nivel M√°ximo</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${progress.unlocked}/${progress.total}</div>
                        <div class="stat-label">Logros (${progress.percentage}%)</div>
                    </div>
                `;

                this.createHistoryChart(filtered, levelFilter);
                this.createHistoryTable(filtered);
            },

            createHistoryChart(sessions, levelFilter) {
                const ctx = document.getElementById('history-chart');
                if (this.historyChart) this.historyChart.destroy();

                if (sessions.length === 0) {
                    ctx.parentElement.style.display = 'none';
                    return;
                }

                ctx.parentElement.style.display = 'block';

                this.historyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sessions.map((s, i) => `S${i + 1}`),
                        datasets: [{
                            label: 'Precisi√≥n (%)',
                            data: sessions.map(s => s.accuracy),
                            borderColor: 'rgba(76, 175, 80, 1)',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            title: {
                                display: true,
                                text: levelFilter === 'all' ? 'Progreso Global - Todas las Sesiones' : `Progreso Nivel ${levelFilter}-Back`
                            },
                            legend: {
                                display: true,
                                position: 'bottom'
                            }
                        },
                        scales: {
                            y: { 
                                min: 0, 
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Precisi√≥n (%)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Sesi√≥n'
                                }
                            }
                        }
                    }
                });
            },

            createHistoryTable(sessions) {
                const container = document.getElementById('history-table-container');
                if (sessions.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999;">No hay datos para este nivel.</p>';
                    return;
                }

                let html = `<table><thead><tr><th>Fecha</th><th>Nivel</th><th>Precisi√≥n</th><th>Aciertos</th><th>Errores</th><th>Modo</th></tr></thead><tbody>`;

                sessions.slice().reverse().forEach(s => {
                    const date = new Date(s.date).toLocaleString('es-ES', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    const color = s.accuracy >= 85 ? '#4caf50' : s.accuracy >= 70 ? '#ff9800' : '#f44336';
                    const modeIcon = s.fast ? '‚ö°' : (s.zen ? 'üßò' : 'üìä');
                    html += `<tr>
                        <td>${date}</td>
                        <td style="text-align: center; font-weight: 700;">${s.level}</td>
                        <td style="color: ${color}; font-weight: 700;">${s.accuracy}%</td>
                        <td>${s.hits}</td>
                        <td>${s.errors}</td>
                        <td style="text-align: center;">${modeIcon}</td>
                    </tr>`;
                });

                html += `</tbody></table>`;
                container.innerHTML = html;
            },

            displayAchievements() {
                const container = document.getElementById('achievements-display');
                if (!container) return;

                const progress = achievements.getProgress();
                
                let html = `
                    <div class="academic-box success-box" style="text-align: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0 0 0.5rem 0;">Progreso de Logros</h3>
                        <div style="font-size: 2rem; font-weight: 800; color: var(--success);">${progress.unlocked} / ${progress.total}</div>
                        <p style="margin: 0.5rem 0 0 0;">${progress.percentage}% completado</p>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
                `;

                Object.values(achievements.list).forEach(achievement => {
                    const unlocked = achievement.unlocked;
                    const opacity = unlocked ? '1' : '0.4';
                    const bgColor = unlocked ? '#e8f5e9' : '#f5f5f5';
                    
                    html += `
                        <div style="background: ${bgColor}; padding: 1.5rem; border-radius: 12px; opacity: ${opacity}; border: 2px solid ${unlocked ? 'var(--success)' : '#ddd'};">
                            <div style="font-size: 3rem; margin-bottom: 0.5rem;">${achievement.medal}</div>
                            <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.3rem;">${achievement.name}</div>
                            <div style="font-size: 0.9rem; color: #666;">${achievement.description}</div>
                            ${unlocked ? '<div style="margin-top: 0.5rem; color: var(--success); font-weight: 600;">‚úì Desbloqueado</div>' : '<div style="margin-top: 0.5rem; color: #999;">üîí Bloqueado</div>'}
                        </div>
                    `;
                });

                html += `</div>`;
                container.innerHTML = html;
            },

            clearHistory() {
                if (confirm('‚ö†Ô∏è ¬øBorrar TODO el historial de entrenamiento?\n\nEsta acci√≥n eliminar√° todas tus sesiones, logros y progreso.\n\nNo se puede deshacer.')) {
                    if (confirm('‚ö†Ô∏è CONFIRMACI√ìN FINAL\n\n¬øEst√°s completamente seguro?\n\nSe perder√° TODO el progreso acumulado.')) {
                        localStorage.removeItem('nback_history');
                        localStorage.removeItem('nback_achievements');
                        achievements.list = Object.keys(achievements.list).reduce((acc, key) => {
                            acc[key] = {...achievements.list[key], unlocked: false};
                            return acc;
                        }, {});
                        this.maxLevelReached = 1;
                        this.selectedLevel = 1;
                        alert('‚úÖ Historial y logros borrados completamente.');
                        this.showHistoryForLevel('all');
                    }
                }
            },

            exportData() {
                try {
                    const data = {
                        version: '3.0',
                        exportDate: new Date().toISOString(),
                        maxLevel: this.maxLevelReached,
                        sessions: this.getHistory(),
                        achievements: Object.keys(achievements.list).reduce((acc, key) => {
                            acc[key] = achievements.list[key].unlocked;
                            return acc;
                        }, {}),
                        config: {
                            zen: game.config.zen,
                            fast: game.config.fast,
                            achievementsEnabled: achievements.enabled
                        }
                    };

                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `DualNBackPro_v3_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    alert('‚úÖ Datos exportados correctamente.\n\nArchivo: ' + link.download);
                } catch (e) {
                    alert('‚ùå Error exportando datos: ' + e.message);
                }
            },

            importData(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        
                        if (!imported.sessions || !Array.isArray(imported.sessions)) {
                            throw new Error('Formato de archivo inv√°lido. Aseg√∫rate de importar un archivo exportado por Dual N-Back Pro.');
                        }

                        const current = this.getHistory();
                        let action = 'replace';
                        
                        if (current.length > 0) {
                            action = confirm('Ya tienes datos existentes.\n\n‚úÖ ACEPTAR = Fusionar datos (mantener ambos)\n‚ùå CANCELAR = Reemplazar (eliminar datos actuales)') ? 'merge' : 'replace';
                        }
                        
                        if (action === 'replace') {
                            localStorage.setItem('nback_history', JSON.stringify(imported.sessions));
                            if (imported.achievements) {
                                localStorage.setItem('nback_achievements', JSON.stringify(imported.achievements));
                            }
                        } else {
                            const merged = [...current, ...imported.sessions];
                            merged.sort((a, b) => new Date(a.date) - new Date(b.date));
                            localStorage.setItem('nback_history', JSON.stringify(merged));
                            
                            if (imported.achievements) {
                                const currentAch = JSON.parse(localStorage.getItem('nback_achievements') || '{}');
                                const mergedAch = {...currentAch, ...imported.achievements};
                                localStorage.setItem('nback_achievements', JSON.stringify(mergedAch));
                            }
                        }

                        this.loadMaxLevel();
                        achievements.load();
                        
                        alert(`‚úÖ Importaci√≥n exitosa\n\nSesiones importadas: ${imported.sessions.length}\nAcci√≥n: ${action === 'merge' ? 'Fusionado' : 'Reemplazado'}`);
                        this.showHistoryForLevel('all');
                    } catch (e) {
                        alert('‚ùå Error importando archivo:\n\n' + e.message);
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            },

            shareResults() {
                const history = this.getHistory();
                if (history.length === 0) {
                    alert('‚ö†Ô∏è No hay datos para compartir a√∫n.');
                    return;
                }

                const avgAccuracy = Math.round(history.reduce((sum, s) => sum + s.accuracy, 0) / history.length);
                const maxLevel = Math.max(...history.map(s => s.level));
                const progress = achievements.getProgress();

                const text = `üß† Mi Progreso en Dual N-Back Pro v3.0

üìä Sesiones: ${history.length}
üéØ Precisi√≥n Media: ${avgAccuracy}%
üöÄ Nivel M√°ximo: ${maxLevel}-Back
üèÜ Logros: ${progress.unlocked}/${progress.total} (${progress.percentage}%)

¬°Entrenando mi memoria de trabajo con ciencia! üî¨`;

                if (navigator.share) {
                    navigator.share({
                        title: 'Mi Progreso - Dual N-Back Pro',
                        text: text
                    }).then(() => {
                        console.log('‚úÖ Compartido exitosamente');
                    }).catch((err) => {
                        console.log('Compartir cancelado:', err);
                        this.fallbackShare(text);
                    });
                } else {
                    this.fallbackShare(text);
                }
            },

            fallbackShare(text) {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(text).then(() => {
                        alert('‚úÖ Texto copiado al portapapeles.\n\nP√©galo donde quieras compartirlo.');
                    }).catch(() => {
                        this.manualCopy(text);
                    });
                } else {
                    this.manualCopy(text);
                }
            },

            manualCopy(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                
                try {
                    document.execCommand('copy');
                    alert('‚úÖ Texto copiado al portapapeles.');
                } catch (err) {
                    alert('‚ö†Ô∏è No se pudo copiar autom√°ticamente.\n\nTexto para copiar:\n\n' + text);
                }
                
                document.body.removeChild(textarea);
            },

            testAudio() {
                AudioEngine.unlock().then(() => {
                    const letters = ['C', 'H', 'K', 'L'];
                    let index = 0;

                    const playNext = () => {
                        if (index >= letters.length) {
                            alert('‚úÖ Test de audio completado.\n\nSi escuchaste las 4 letras claramente (C, H, K, L), el sistema de audio funciona correctamente.');
                            return;
                        }
                        AudioEngine.speak(letters[index]);
                        index++;
                        setTimeout(playNext, 1500);
                    };

                    alert('üîä Iniciando test de audio...\n\nEscuchar√°s 4 letras: C, H, K, L\n\nAseg√∫rate de tener el volumen adecuado.');
                    setTimeout(playNext, 500);
                });
            }
        };

        // Inicializar aplicaci√≥n cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

        // Prevenir zoom en iOS mediante doble tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (event) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Debug global (solo en desarrollo)
        window.debugApp = {
            app: app,
            game: game,
            audio: AudioEngine,
            achievements: achievements,
            nav: navigationManager,
            wakeLock: wakeLockManager,
            clearAll: () => {
                if (confirm('‚ö†Ô∏è MODO DEBUG\n\n¬øBorrar TODOS los datos locales?')) {
                    localStorage.clear();
                    location.reload();
                }
            }
        };

        console.log('%cüß† Dual N-Back Pro v3.0', 'color: #3a7bd5; font-size: 20px; font-weight: bold;');
        console.log('%c‚úÖ Sistema inicializado correctamente', 'color: #4caf50; font-size: 14px;');
        console.log('%cüí° Tip: Escribe debugApp en consola para acceder a herramientas de desarrollo', 'color: #666; font-size: 12px;');
    </script>
</body>
</html>
